{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<h1>Championship Settings</h1>

<div class="settings-container">
    <!-- Left column: Settings controls -->
    <div class="settings-column">
        <form id="settingsForm">
            <div class="settings-section">
                <h2>Points & Bonuses</h2>
                <!-- Basic point settings -->
                <div class="form-group">
                    <label for="in_office">In Office Points:</label>
                    <input type="number" id="in_office" name="points.in_office" value="{{ settings.points.in_office }}" min="0" max="20">
                </div>
                <div class="form-group">
                    <label for="remote">Remote Work Points:</label>
                    <input type="number" id="remote" name="points.remote" value="{{ settings.points.remote }}" min="0" max="20">
                </div>
                <div class="form-group">
                    <label for="late_bonus">Late Arrival Bonus:</label>
                    <input type="number" id="late_bonus" name="late_bonus" value="{{ settings.late_bonus }}" min="0" max="5">
                </div>
                <div class="form-group">
                    <label for="sick">Sick Day Points:</label>
                    <input type="number" id="sick" name="points.sick" value="{{ settings.points.sick }}" min="0" max="20">
                </div>
                <div class="form-group">
                    <label for="leave">Annual Leave Points:</label>
                    <input type="number" id="leave" name="points.leave" value="{{ settings.points.leave }}" min="0" max="20">
                </div>
            </div>

            <div class="settings-section">
                <h2>Remote Work Configuration</h2>
                <p class="helper-text">Select days when remote workers can earn position bonus points</p>
                <div class="remote-days-table">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in core_users %}
                            <tr class="user-row" data-user="{{ user }}">
                                <td>{{ user }}</td>
                                {% for day in ['mon', 'tue', 'wed', 'thu', 'fri'] %}
                                <td>
                                    <input type="checkbox" 
                                           name="remote_days.{{ user }}"
                                           value="{{ day }}"
                                           {% if day in settings.remote_days.get(user, []) %}checked{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="settings-section">
                <h2>Core Users</h2>
                <p class="helper-text">Select users to include in attendance tracking</p>
                <div class="core-users-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Registered User</th>
                                <th>Core Member</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registered_user in registered_users %}
                            <tr>
                                <td>{{ registered_user }}</td>
                                <td>
                                    <input type="checkbox" 
                                           class="core-user-checkbox"
                                           name="core_users"
                                           value="{{ registered_user }}"
                                           {% if registered_user in core_users %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="settings-section">
                <h2>Streak Settings</h2>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable_streaks" name="enable_streaks" 
                               {% if settings.enable_streaks %}checked{% endif %}>
                        Enable Streak Bonus System
                    </label>
                </div>
                
                <div class="form-group streak-settings" {% if not settings.enable_streaks %}style="display: none"{% endif %}>
                    <label for="streak_multiplier">Streak Multiplier (points per day):</label>
                    <input type="number" id="streak_multiplier" name="streak_multiplier" 
                           value="{{ settings.streak_multiplier }}" min="0" max="5" step="0.1">
                </div>
            </div>

            <div class="settings-section">
                <h2>Scoring Rules Editor</h2>
                <button type="button" class="open-rules-editor">Open Rules Editor</button>
            </div>

            <button type="submit" class="save-button">Save All Settings</button>
        </form>
    </div>

    <!-- Add Modal for Rules Editor -->
    <div id="rulesEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Scoring Rules Editor</h2>
                <span class="close">&times;</span>
            </div>
            <div class="scoring-dsl-container">
                <div class="scoring-blocks-palette">
                    <h3>Available Blocks</h3>
                    <div class="block-category">
                        <h4>Conditions</h4>
                        <div class="block" draggable="true" data-type="condition" data-template="if {time} {operator} {value}">
                            Time Condition
                        </div>
                        <div class="block" draggable="true" data-type="condition" data-template="if {day} is {value}">
                            Day Condition
                        </div>
                        <div class="block" draggable="true" data-type="condition" data-template="if {status} is {value}">
                            Status Condition
                        </div>
                        <div class="block" draggable="true" data-type="condition" data-template="if {streak} {operator} {value}">
                            Streak Condition
                        </div>
                    </div>
                    <div class="block-category">
                        <h4>Actions</h4>
                        <div class="block" draggable="true" data-type="action" data-template="add {points} points">
                            Add Points
                        </div>
                        <div class="block" draggable="true" data-type="action" data-template="multiply points by {value}">
                            Multiply Points
                        </div>
                        <div class="block" draggable="true" data-type="action" data-template="add streak bonus {value}">
                            Add Streak Bonus
                        </div>
                    </div>
                </div>
                
                <div class="scoring-rules-builder">
                    <h3>Current Rules</h3>
                    <div id="rulesContainer" class="rules-container">
                        <!-- Rules will be added here -->
                    </div>
                    <button type="button" onclick="saveRules()">Save Rules</button>
                </div>

                <div class="scoring-preview">
                    <h3>Rule Preview</h3>
                    <pre id="rulePreview" class="rule-preview"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Right column: Scoring explanation -->
    <div class="info-column">
        <div class="scoring-explanation">
            <h2>How Scoring Works</h2>
            <div class="mode-specific-info">
                <h3>Position Bonus System</h3>
                <div id="lastInInfo">
                    <h4>Last-In Championship Mode</h4>
                    <p>Points increase with later arrival times:</p>
                    <ul>
                        <li>Last person to arrive gets maximum bonus (position × {{ settings.late_bonus }})</li>
                        <li>Earlier arrivals get progressively smaller bonuses</li>
                        <li>First arrival gets minimum position bonus</li>
                    </ul>
                </div>
                <div id="earlyBirdInfo" style="display: none;">
                    <h4>Early Bird Mode</h4>
                    <p>Points increase with earlier arrival times:</p>
                    <ul>
                        <li>First person to arrive gets maximum bonus (position × {{ settings.late_bonus }})</li>
                        <li>Later arrivals get progressively smaller bonuses</li>
                        <li>Last arrival gets minimum position bonus</li>
                    </ul>
                </div>
            </div>

            <div class="example-box">
                <h4>Base Points</h4>
                <ul>
                    <li>In-office: {{ settings.points.in_office }} points</li>
                    <li>Remote work: {{ settings.points.remote }} points</li>
                    <li>Sick leave: {{ settings.points.sick }} points</li>
                    <li>Annual leave: {{ settings.points.leave }} points</li>
                </ul>
            </div>

            <div class="example-box">
                <h4>Example Calculations</h4>
                <div id="lastInExample">
                    <h5>Last-In Mode Example (5 people)</h5>
                    <table class="example-table">
                        <tr><th>Position</th><th>Calculation</th><th>Total</th></tr>
                        <tr>
                            <td>Last (5th)</td>
                            <td>{{ settings.points.in_office }} + (5 × {{ settings.late_bonus }})</td>
                            <td>{{ settings.points.in_office + (5 * settings.late_bonus) }}</td>
                        </tr>
                        <tr>
                            <td>First</td>
                            <td>{{ settings.points.in_office }} + (1 × {{ settings.late_bonus }})</td>
                            <td>{{ settings.points.in_office + settings.late_bonus }}</td>
                        </tr>
                    </table>
                </div>
                <div id="earlyBirdExample" style="display: none;">
                    <h5>Early Bird Mode Example (5 people)</h5>
                    <table class="example-table">
                        <tr><th>Position</th><th>Calculation</th><th>Total</th></tr>
                        <tr>
                            <td>First</td>
                            <td>{{ settings.points.in_office }} + (5 × {{ settings.late_bonus }})</td>
                            <td>{{ settings.points.in_office + (5 * settings.late_bonus) }}</td>
                        </tr>
                        <tr>
                            <td>Last (5th)</td>
                            <td>{{ settings.points.in_office }} + (1 × {{ settings.late_bonus }})</td>
                            <td>{{ settings.points.in_office + settings.late_bonus }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Replace existing streak explanation with updated one -->
            {% if settings.enable_streaks %}
            <div class="example-box streak-explanation">
                <h4>Streak System</h4>
                <p>The streak system affects scores differently based on the mode:</p>
                
                <div class="mode-specific">
                    <h5>Early Bird Mode</h5>
                    <ul>
                        <li>Streaks add bonus points (rewards consistent early arrival)</li>
                        <li>Current multiplier: +{{ settings.streak_multiplier }} points per day in streak</li>
                    </ul>
                    
                    <h5>Last-In Mode</h5>
                    <ul>
                        <li>Streaks subtract points (penalizes consistent lateness)</li>
                        <li>Current multiplier: -{{ settings.streak_multiplier }} points per day in streak</li>
                    </ul>
                </div>
                
                <div class="streak-rules">
                    <h5>General Rules</h5>
                    <ul>
                        <li>Weekend days don't break streaks</li>
                        <li>Both office and remote work count</li>
                        <li>Sick days or annual leave break the streak</li>
                        <li>Maximum gap allowed is 3 days (for weekends)</li>
                    </ul>
                </div>
                
                <div class="streak-example">
                    <h5>Example Calculations</h5>
                    <table class="example-table">
                        <tr>
                            <th>Mode</th>
                            <th>Streak</th>
                            <th>Effect on Score</th>
                        </tr>
                        <tr>
                            <td>Early Bird</td>
                            <td>3 days</td>
                            <td>+{{ 3 * settings.streak_multiplier }} points</td>
                        </tr>
                        <tr>
                            <td>Last-In</td>
                            <td>3 days</td>
                            <td>-{{ 3 * settings.streak_multiplier }} points</td>
                        </tr>
                    </table>
                </div>

                <div class="streak-rules">
                    <h5>Streak Rules</h5>
                    <ul>
                        <li>Weekend days don't break streaks</li>
                        <li>Both office and remote work count</li>
                        <li>Sick days or annual leave break the streak</li>
                        <li>Maximum gap allowed is 3 days (for weekends)</li>
                        <li>Streak bonuses only affect scores up to the day being viewed</li>
                        <li>Future attendance cannot affect past scores</li>
                    </ul>
                </div>

                <div class="streak-example">
                    <h5>Example Date-Aware Calculations</h5>
                    <p>If viewing rankings for 2024-01-15:</p>
                    <table class="example-table">
                        <tr>
                            <th>Scenario</th>
                            <th>Effect on Score</th>
                        </tr>
                        <tr>
                            <td>3-day streak up to Jan 15</td>
                            <td>±{{ 3 * settings.streak_multiplier }} points</td>
                        </tr>
                        <tr>
                            <td>Attendance on Jan 16-20</td>
                            <td>No effect on Jan 15 score</td>
                        </tr>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.settings-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.settings-column {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.info-column {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

.settings-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.settings-section:last-child {
    border-bottom: none;
}

.remote-days-table {
    margin: 20px 0;
    overflow-x: auto;
}

.remote-days-table table {
    width: 100%;
    border-collapse: collapse;
}

.remote-days-table td {
    text-align: center;
    padding: 10px;
}

.remote-days-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
}

.helper-text {
    color: #666;
    font-size: 0.9em;
    margin: 5px 0 15px;
}

/* ...existing styles... */

.example-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin: 15px 0;
}

.example-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

.example-table th {
    background: var(--primary-color);
    color: white;
    padding: 8px;
}

.example-table td {
    padding: 8px;
    border-bottom: 1px solid #dee2e6;
}

.example-box .calculation {
    font-family: monospace;
    background: #e9ecef;
    padding: 2px 6px;
    border-radius: 4px;
}

.scoring-explanation {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.scoring-explanation ul {
    list-style-type: none;
    padding-left: 20px;
}

.scoring-explanation ul li {
    margin: 8px 0;
    position: relative;
}

scoring-explanation ul li::before {
    content: "•";
    color: var(--accent-color);
    font-weight: bold;
    position: absolute;
    left: -15px;
}

.remote-days-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
    margin: 0;
    padding: 0;
}

.remote-days-table th {
    padding: 12px;
    text-align: center;
    background: var(--primary-color);
    color: white;
}

.remote-days-table td {
    text-align: center;
    padding: 12px;
    border: 1px solid #dee2e6;
}

.remote-days-table tr:nth-child(even) {
    background: #f8f9fa;
}

.remote-days-table tr:hover {
    background: #e9ecef;
}

.core-users-table {
    margin: 20px 0;
    overflow-x: auto;
}

.core-users-table table {
    width: 100%;
    border-collapse: collapse;
}

.core-users-table td {
    text-align: left;
    padding: 10px;
}

.core-users-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
}

.streak-example {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
}

.streak-example h5 {
    margin-top: 0;
    color: var(--primary-color);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
}

.mode-specific {
    margin: 15px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}

.mode-specific h5 {
    color: var(--primary-color);
    margin-top: 10px;
}

.streak-rules {
    margin: 15px 0;
    padding: 10px;
    background: #e9ecef;
    border-radius: 4px;
}

.scoring-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.setting-explanation {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
}

.points-preview {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
}

.calculator {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.points-breakdown {
    font-family: monospace;
    white-space: pre-wrap;
    background: #fff;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.scoring-dsl-container {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 20px;
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.scoring-blocks-palette {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.block {
    background: var(--accent-color);
    color: white;
    padding: 10px;
    margin: 5px 0;
    border-radius: 4px;
    cursor: grab;
    user-select: none;
}

.block[data-type="condition"] {
    background: var(--primary-color);
}

.block[data-type="action"] {
    background: var(--success-color);
}

.rules-container {
    min-height: 200px;
    padding: 15px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.rule-block {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    margin: 5px 0;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px dashed #dee2e6;
}

.rule-block input, .rule-block select {
    padding: 4px;
    border-radius: 3px;
    border: 1px solid #dee2e6;
}

.rule-preview {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    white-space: pre-wrap;
    font-family: monospace;
}

.block-category {
    margin-bottom: 20px;
}

.block-category h4 {
    color: var(--primary-color);
    margin-bottom: 10px;
}

.dragging {
    opacity: 0.5;
    cursor: move;
}

.drag-over {
    border: 2px dashed var(--accent-color);
}

.rules-container {
    min-height: 100px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.rule-block {
    cursor: move;
    transition: transform 0.2s ease;
}

.rule-block:hover {
    transform: translateX(5px);
}

.rule-block button {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.rule-block:hover button {
    opacity: 1;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 1200px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.open-rules-editor {
    background: var(--accent-color);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

.open-rules-editor:hover {
    background: var(--primary-color);
}

.rule-block {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: move;
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;
}

.rule-block.dragging {
    opacity: 0.5;
    background: #f0f0f0;
}

.rule-block input,
.rule-block select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.rule-block button {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #ff4444;
    cursor: pointer;
    font-size: 18px;
    opacity: 0;
    transition: opacity 0.2s;
}

.rule-block:hover button {
    opacity: 1;
}

.rules-container {
    min-height: 200px;
    border: 2px dashed #ddd;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.rules-container.drag-over {
    background: #f0f7ff;
    border-color: var(--accent-color);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update mode-specific info based on championship toggle
    function updateModeInfo() {
        const isLastIn = document.getElementById('championshipToggle').checked;
        document.getElementById('lastInInfo').style.display = isLastIn ? 'block' : 'none';
        document.getElementById('earlyBirdInfo').style.display = isLastIn ? 'none' : 'block';
        document.getElementById('lastInExample').style.display = isLastIn ? 'block' : 'none';
        document.getElementById('earlyBirdExample').style.display = isLastIn ? 'none' : 'block';
    }

    // Initial update
    updateModeInfo();

    // Listen for mode changes
    document.getElementById('championshipToggle').addEventListener('change', updateModeInfo);
});

document.getElementById('settingsForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    
    // Collect basic settings
    const formData = new FormData(event.target);
    const settings = {
        points: {
            in_office: parseInt(formData.get('points.in_office')),
            remote: parseInt(formData.get('points.remote')),
            sick: parseInt(formData.get('points.sick')),
            leave: parseInt(formData.get('points.leave'))
        },
        late_bonus: parseInt(formData.get('late_bonus')),
        remote_days: {},
        core_users: Array.from(document.querySelectorAll('.core-user-checkbox:checked'))
                       .map(checkbox => checkbox.value),
        enable_streaks: document.getElementById('enable_streaks').checked,
        streak_multiplier: parseFloat(document.getElementById('streak_multiplier').value)
    };
    
    // Collect remote days settings
    document.querySelectorAll('.user-row').forEach(row => {
        const user = row.dataset.user;
        const days = [];
        row.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            days.push(checkbox.value);
        });
        settings.remote_days[user] = days;
    });
    
    try {
        const response = await fetch('/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        if (!response.ok) throw new Error('Failed to save settings');
        
        const result = await response.json();
        alert(result.message);
        location.reload();
    } catch (error) {
        alert('Error saving settings: ' + error.message);
    }
});

document.getElementById('enable_streaks').addEventListener('change', function() {
    const streakSettings = document.querySelector('.streak-settings');
    const streakExplanation = document.getElementById('streakExplanation');
    streakSettings.style.display = this.checked ? 'block' : 'none';
    streakExplanation.style.display = this.checked ? 'block' : 'none';
});

function calculatePoints() {
    // Only run if we're in the calculator view
    if (!document.getElementById('position_multiplier')) {
        return; // Exit if required elements don't exist
    }

    const settings = {
        position_multiplier: parseFloat(document.getElementById('position_multiplier').value) || 0,
        early_bonus: parseFloat(document.getElementById('early_bonus').value) || 0,
        weekend_multiplier: parseFloat(document.getElementById('weekend_multiplier').value) || 1,
        holiday_multiplier: parseFloat(document.getElementById('holiday_multiplier').value) || 1,
        consecutive_days_bonus: parseFloat(document.getElementById('consecutive_days_bonus').value) || 0
    };

    const scenario = document.getElementById('scenarioSelect').value;
    const arrivalTime = document.getElementById('arrivalTime').value;
    const status = document.getElementById('statusSelect').value;
    const position = parseInt(document.getElementById('position').value);
    const streak = parseInt(document.getElementById('streak').value);

    // Calculate base points
    let points = status === 'in_office' ? settings.points.in_office : settings.points.remote;
    let breakdown = `Base points (${status}): ${points}\n`;

    // Apply position bonus
    const positionBonus = position * settings.position_multiplier;
    points += positionBonus;
    breakdown += `Position bonus: ${positionBonus}\n`;

    // Apply time bonus
    const arrivalHour = parseInt(arrivalTime.split(':')[0]);
    if (arrivalHour < 9) {
        const earlyBonus = settings.early_bonus;
        points += earlyBonus;
        breakdown += `Early arrival bonus: ${earlyBonus}\n`;
    }

    // Apply scenario multiplier
    let multiplier = 1;
    if (scenario === 'weekend') multiplier = settings.weekend_multiplier;
    if (scenario === 'holiday') multiplier = settings.holiday_multiplier;
    if (multiplier > 1) {
        const bonusPoints = points * (multiplier - 1);
        points *= multiplier;
        breakdown += `${scenario} multiplier (${multiplier}x): +${bonusPoints}\n`;
    }

    // Apply streak bonus
    if (streak > 0) {
        const streakBonus = streak * settings.consecutive_days_bonus;
        points += streakBonus;
        breakdown += `Streak bonus (${streak} days): ${streakBonus}\n`;
    }

    breakdown += `\nTotal Points: ${points.toFixed(2)}`;
    document.getElementById('pointsBreakdown').textContent = breakdown;
}

// Add event listeners to all inputs to update calculation in real-time
document.querySelectorAll('.calculator input, .calculator select').forEach(input => {
    input.addEventListener('change', calculatePoints);
});

// Initial calculation
calculatePoints();

// Initialize drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
    loadExistingRules();
});

function initializeDragAndDrop() {
    const blocks = document.querySelectorAll('.block');
    const rulesContainer = document.getElementById('rulesContainer');

    blocks.forEach(block => {
        block.addEventListener('dragstart', handleDragStart);
        block.addEventListener('dragend', handleDragEnd);
    });

    rulesContainer.addEventListener('dragover', handleDragOver);
    rulesContainer.addEventListener('dragenter', handleDragEnter);
    rulesContainer.addEventListener('dragleave', handleDragLeave);
    rulesContainer.addEventListener('drop', handleDrop);
    
    // Make existing rules draggable within container
    makeRulesDraggable();
}

function makeRulesDraggable() {
    const ruleBlocks = document.querySelectorAll('.rule-block');
    ruleBlocks.forEach(block => {
        block.draggable = true;
        block.addEventListener('dragstart', handleRuleDragStart);
        block.addEventListener('dragend', handleDragEnd);
    });
}

function handleDragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', JSON.stringify({
        type: e.target.dataset.type,
        template: e.target.dataset.template,
        isNew: true
    }));
}

function handleRuleDragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', JSON.stringify({
        type: e.target.dataset.type,
        template: e.target.innerHTML,
        isNew: false,
        index: Array.from(e.target.parentNode.children).indexOf(e.target)
    }));
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const afterElement = getDragAfterElement(e.target, e.clientY);
    const draggable = document.querySelector('.dragging');
    if (draggable) {
        if (afterElement) {
            e.target.insertBefore(draggable, afterElement);
        } else {
            e.target.appendChild(draggable);
        }
    }
}

function handleDragEnter(e) {
    e.preventDefault();
    e.target.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.target.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('drag-over');
    
    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
    
    if (data.isNew) {
        createRuleBlock(data.type, data.template);
    } else {
        // Reorder existing rule
        const rules = Array.from(document.querySelectorAll('.rule-block'));
        const movedRule = rules[data.index];
        const afterElement = getDragAfterElement(e.target, e.clientY);
        if (afterElement) {
            e.target.insertBefore(movedRule, afterElement);
        } else {
            e.target.appendChild(movedRule);
        }
    }
    
    updateRulePreview();
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.rule-block:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Update existing createRuleBlock function
function createRuleBlock(type, template) {
    const block = document.createElement('div');
    block.className = 'rule-block';
    block.dataset.type = type;
    block.draggable = true;
    block.addEventListener('dragstart', handleRuleDragStart);
    block.addEventListener('dragend', handleDragEnd);
    
    const templateParts = template.split(/[{}]/);
    templateParts.forEach(part => {
        if (part.trim()) {
            if (part.includes('operator')) {
                const select = document.createElement('select');
                select.innerHTML = `
                    <option value="<">before</option>
                    <option value=">">after</option>
                    <option value="=">=</option>
                    <option value=">=">>=</option>
                    <option value="<="><=</option>
                `;
                block.appendChild(select);
            } else if (part.includes('value') || part.includes('points')) {
                const input = document.createElement('input');
                input.type = 'number';
                input.placeholder = part;
                block.appendChild(input);
            } else if (part.includes('status')) {
                const select = document.createElement('select');
                select.innerHTML = `
                    <option value="in_office">in office</option>
                    <option value="remote">remote</option>
                    <option value="sick">sick</option>
                    <option value="leave">leave</option>
                `;
                block.appendChild(select);
            } else if (part.includes('day')) {
                const select = document.createElement('select');
                select.innerHTML = `
                    <option value="weekday">weekday</option>
                    <option value="weekend">weekend</option>
                    <option value="monday">Monday</option>
                    <option value="friday">Friday</option>
                `;
                block.appendChild(select);
            } else {
                const span = document.createElement('span');
                span.textContent = part;
                block.appendChild(span);
            }
        }
    });

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = '✕';
    deleteBtn.onclick = () => block.remove();
    block.appendChild(deleteBtn);

    document.getElementById('rulesContainer').appendChild(block);
    updateRulePreview();
}

function updateRulePreview() {
    const rules = [];
    document.querySelectorAll('.rule-block').forEach(block => {
        const parts = [];
        block.childNodes.forEach(node => {
            if (node.tagName === 'SELECT' || node.tagName === 'INPUT') {
                parts.push(node.value);
            } else if (node.tagName === 'SPAN') {
                parts.push(node.textContent.trim());
            }
        });
        rules.push(parts.join(' '));
    });

    const preview = rules.join('\n');
    document.getElementById('rulePreview').textContent = preview;

    // Add example calculation
    const example = calculateExampleWithRules(rules);
    document.getElementById('rulePreview').textContent += '\n\nExample Calculation:\n' + example;
}

function calculateExampleWithRules(rules) {
    const exampleEntry = {
        time: '09:00',
        date: new Date().toISOString().split('T')[0],
        status: 'in_office',
        name: 'Example User'
    };

    let points = 10; // Base points
    let explanation = `Base points: ${points}\n`;

    rules.forEach(rule => {
        // Parse and apply rule logic here
        // This is a simplified version
        if (rule.includes('add')) {
            const amount = parseInt(rule.match(/add (\d+)/)[1]);
            points += amount;
            explanation += `Added ${amount} points\n`;
        } else if (rule.includes('multiply')) {
            const factor = parseFloat(rule.match(/multiply.*?(\d+\.?\d*)/)[1]);
            points *= factor;
            explanation += `Multiplied by ${factor}\n`;
        }
    });

    explanation += `Final points: ${points}`;
    return explanation;
}

function saveRules() {
    const rules = [];
    document.querySelectorAll('.rule-block').forEach(block => {
        const rule = {
            type: block.dataset.type,
        };
        
        // Collect all inputs and selects as properties
        block.querySelectorAll('input, select').forEach(input => {
            const label = input.previousElementSibling?.textContent?.toLowerCase().replace(/[^a-z]/g, '') || 'value';
            if (input.tagName === 'SELECT') {
                rule[label] = input.value;
                if (label === 'operator') {
                    rule.operator = input.value;
                }
            } else {
                rule[label] = input.value;
            }
        });
        
        rules.push(rule);
    });

    // Get current settings from form
    const formData = new FormData(document.getElementById('settingsForm'));
    const settings = {
        points: {
            in_office: parseInt(formData.get('points.in_office')),
            remote: parseInt(formData.get('points.remote')),
            sick: parseInt(formData.get('points.sick')),
            leave: parseInt(formData.get('points.leave')),
            rules: rules  // Add rules to points object
        },
        late_bonus: parseFloat(formData.get('late_bonus')),
        remote_days: {},
        core_users: Array.from(document.querySelectorAll('.core-user-checkbox:checked'))
                       .map(checkbox => checkbox.value),
        enable_streaks: document.getElementById('enable_streaks').checked,
        streak_multiplier: parseFloat(document.getElementById('streak_multiplier').value)
    };

    // Collect remote days
    document.querySelectorAll('.user-row').forEach(row => {
        const user = row.dataset.user;
        const days = Array.from(row.querySelectorAll('input[type="checkbox"]:checked'))
                         .map(cb => cb.value);
        settings.remote_days[user] = days;
    });

    // Save settings
    fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        alert('Settings and rules saved successfully!');
        updateScoringExplanation(rules);
        location.reload();
    })
    .catch(error => alert('Error saving settings: ' + error));
}

function updateScoringExplanation(rules) {
    const explanation = document.querySelector('.scoring-explanation');
    const rulesList = document.createElement('div');
    rulesList.className = 'current-rules';
    rulesList.innerHTML = `
        <h3>Current Scoring Rules</h3>
        <pre>${JSON.stringify(rules, null, 2)}</pre>
    `;
    
    // Update or append the rules explanation
    const existingRules = explanation.querySelector('.current-rules');
    if (existingRules) {
        existingRules.replaceWith(rulesList);
    } else {
        explanation.appendChild(rulesList);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('rulesEditorModal');
    const openBtn = document.querySelector('.open-rules-editor');
    const closeBtn = document.querySelector('.close');
    const rulesContainer = document.getElementById('rulesContainer');

    openBtn.onclick = function() {
        modal.style.display = 'block';
        loadExistingRules();
    }

    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    // Initialize drag and drop
    const blocks = document.querySelectorAll('.block');
    blocks.forEach(block => {
        block.addEventListener('dragstart', handleDragStart);
        block.addEventListener('dragend', handleDragEnd);
    });

    rulesContainer.addEventListener('dragover', handleDragOver);
    rulesContainer.addEventListener('dragenter', handleDragEnter);
    rulesContainer.addEventListener('dragleave', handleDragLeave);
    rulesContainer.addEventListener('drop', handleDrop);
});

function handleDragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.setData('text/plain', JSON.stringify({
        type: e.target.dataset.type,
        template: e.target.dataset.template,
        isNew: true
    }));
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        if (data.isNew) {
            createRuleBlock(data.type, data.template);
        }
    } catch (err) {
        console.error('Error handling drop:', err);
    }
}

function createRuleBlock(type, template) {
    const block = document.createElement('div');
    block.className = 'rule-block';
    block.draggable = true;
    block.dataset.type = type;
    
    const parts = template.split(/[{}]/);
    parts.forEach(part => {
        if (!part.trim()) return;
        
        if (part.includes('operator')) {
            const select = document.createElement('select');
            select.innerHTML = `
                <option value="<">before</option>
                <option value=">">after</option>
                <option value="=">=</option>
                <option value=">=">>=</option>
                <option value="<="><=</option>
            `;
            select.addEventListener('change', updateRulePreview);
            block.appendChild(select);
        } else if (part.includes('time')) {
            const input = document.createElement('input');
            input.type = 'time';
            input.value = '09:00';
            input.addEventListener('change', updateRulePreview);
            block.appendChild(input);
        } else if (part.includes('value') || part.includes('points')) {
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '0';
            input.step = '0.1';
            input.value = '1';
            input.addEventListener('change', updateRulePreview);
            block.appendChild(input);
        } else if (part.includes('status')) {
            const select = document.createElement('select');
            select.innerHTML = `
                <option value="in_office">in office</option>
                <option value="remote">remote</option>
                <option value="sick">sick</option>
                <option value="leave">leave</option>
            `;
            select.addEventListener('change', updateRulePreview);
            block.appendChild(select);
        } else if (part.includes('day')) {
            const select = document.createElement('select');
            select.innerHTML = `
                <option value="weekday">weekday</option>
                <option value="weekend">weekend</option>
                <option value="monday">Monday</option>
                <option value="friday">Friday</option>
            `;
            select.addEventListener('change', updateRulePreview);
            block.appendChild(select);
        } else {
            const span = document.createElement('span');
            span.textContent = part;
            block.appendChild(span);
        }
    });

    const deleteBtn = document.createElement('button');
    deleteBtn.innerHTML = '&times;';
    deleteBtn.onclick = () => {
        block.remove();
        updateRulePreview();
    };
    block.appendChild(deleteBtn);

    rulesContainer.appendChild(block);
    makeBlockDraggable(block);
    updateRulePreview();
}

function makeBlockDraggable(block) {
    block.addEventListener('dragstart', (e) => {
        e.target.classList.add('dragging');
        const index = Array.from(rulesContainer.children).indexOf(e.target);
        e.dataTransfer.setData('text/plain', JSON.stringify({
            index: index,
            isNew: false
        }));
    });

    block.addEventListener('dragend', (e) => {
        e.target.classList.remove('dragging');
    });
}

function updateRulePreview() {
    const preview = [];
    document.querySelectorAll('.rule-block').forEach(block => {
        let rule = '';
        block.childNodes.forEach(node => {
            if (node.tagName === 'SELECT' || node.tagName === 'INPUT') {
                rule += node.value + ' ';
            } else if (node.tagName === 'SPAN') {
                rule += node.textContent + ' ';
            }
        });
        preview.push(rule.trim());
    });
    
    document.getElementById('rulePreview').textContent = preview.join('\n');
}

// ... rest of your existing script ...
</script>
{% endblock %}
