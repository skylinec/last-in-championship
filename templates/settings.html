{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<h1>Championship Settings</h1>

<div class="settings-container">
    <div class="settings-section">
        <h2>Points & Bonuses</h2>
        <form id="settingsForm">
            <!-- Basic point settings -->
            <div class="form-group">
                <label for="in_office">In Office Points:</label>
                <input type="number" id="in_office" name="points.in_office" value="{{ settings.points.in_office }}" min="0" max="20">
            </div>
            <div class="form-group">
                <label for="remote">Remote Work Points:</label>
                <input type="number" id="remote" name="points.remote" value="{{ settings.points.remote }}" min="0" max="20">
            </div>
            <div class="form-group">
                <label for="late_bonus">Late Arrival Bonus:</label>
                <input type="number" id="late_bonus" name="late_bonus" value="{{ settings.late_bonus }}" min="0" max="5">
            </div>

            <!-- Remote work days configuration -->
            <h3>Remote Work Late Bonus Days</h3>
            <p class="helper-text">Select days when remote workers can earn late bonus points</p>
            <div class="remote-days-table">
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Mon</th>
                            <th>Tue</th>
                            <th>Wed</th>
                            <th>Thu</th>
                            <th>Fri</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in core_users %}
                        <tr class="user-row" data-user="{{ user }}">
                            <td>{{ user }}</td>
                            {% for day in ['mon', 'tue', 'wed', 'thu', 'fri'] %}
                            <td>
                                <input type="checkbox" 
                                       name="remote_days.{{ user }}"
                                       value="{{ day }}"
                                       {% if day in settings.remote_days.get(user, []) %}checked{% endif %}>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <button type="submit" class="save-button">Save All Settings</button>
        </form>
    </div>

    <div class="scoring-explanation">
        <h2>How Scoring Works</h2>
        
        <h3>Daily Scoring</h3>
        <p>Points are awarded based on:</p>
        <ul>
            <li>Base points (10) for all attendance types (in-office, remote, sick, leave)</li>
            <li>Late arrival bonus (position × late_bonus) applies to:
                <ul>
                    <li>In-office attendance (always)</li>
                    <li>Remote work on designated remote days only</li>
                </ul>
            </li>
            <li>Position bonus increases with later arrival (promoting the "Last-In" concept)</li>
            <li>Sick days and leave days are neutral - they receive base points only</li>
        </ul>
        
        <div class="example-box">
            <h4>Example Calculations</h4>
            <table class="example-table">
                <tr>
                    <th>Scenario</th>
                    <th>Calculation</th>
                    <th>Total</th>
                </tr>
                <tr>
                    <td>Last In Office (5th person)</td>
                    <td>10 + (5 × {{ settings.late_bonus }})</td>
                    <td>{{ 10 + (5 * settings.late_bonus) }}</td>
                </tr>
                <tr>
                    <td>Second-to-Last (4th person)</td>
                    <td>10 + (4 × {{ settings.late_bonus }})</td>
                    <td>{{ 10 + (4 * settings.late_bonus) }}</td>
                </tr>
                <tr>
                    <td>Last Remote (eligible day)</td>
                    <td>10 + (5 × {{ settings.late_bonus }})</td>
                    <td>{{ 10 + (5 * settings.late_bonus) }}</td>
                </tr>
                <tr>
                    <td>Remote (non-eligible day)</td>
                    <td>10 (base only)</td>
                    <td>10</td>
                </tr>
                <tr>
                    <td>Sick Day</td>
                    <td>5 (base only)</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>Annual Leave</td>
                    <td>5 (base only)</td>
                    <td>5</td>
                </tr>
            </table>
        </div>

        <div class="example-box">
            <h4>Scoring Notes</h4>
            <ul>
                <li>Rankings are based only on in-office and eligible remote work days</li>
                <li>Sick days and leave days don't affect your average score</li>
                <li>Later arrivals earn more points (multiplied by position number)</li>
                <li>Remote work only earns position bonus on designated days</li>
                <li>Weekly and monthly scores are averages of daily scores (excluding sick/leave)</li>
            </ul>
        </div>
    </div>
</div>

<style>
.settings-container {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 40px;
    align-items: start;
}

.remote-days-table {
    margin: 20px 0;
    overflow-x: auto;
}

.remote-days-table table {
    width: 100%;
    border-collapse: collapse;
}

.remote-days-table td {
    text-align: center;
    padding: 10px;
}

.remote-days-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
}

.helper-text {
    color: #666;
    font-size: 0.9em;
    margin: 5px 0 15px;
}

/* ...existing styles... */

.example-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin: 15px 0;
}

.example-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

.example-table th {
    background: var(--primary-color);
    color: white;
    padding: 8px;
}

.example-table td {
    padding: 8px;
    border-bottom: 1px solid #dee2e6;
}

.example-box .calculation {
    font-family: monospace;
    background: #e9ecef;
    padding: 2px 6px;
    border-radius: 4px;
}

.scoring-explanation {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.scoring-explanation ul {
    list-style-type: none;
    padding-left: 20px;
}

.scoring-explanation ul li {
    margin: 8px 0;
    position: relative;
}

.scoring-explanation ul li::before {
    content: "•";
    color: var(--accent-color);
    font-weight: bold;
    position: absolute;
    left: -15px;
}

.remote-days-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
    margin: 0;
    padding: 0;
}

.remote-days-table th {
    padding: 12px;
    text-align: center;
    background: var(--primary-color);
    color: white;
}

.remote-days-table td {
    text-align: center;
    padding: 12px;
    border: 1px solid #dee2e6;
}

.remote-days-table tr:nth-child(even) {
    background: #f8f9fa;
}

.remote-days-table tr:hover {
    background: #e9ecef;
}
</style>

<script>
document.getElementById('settingsForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    
    // Collect basic settings
    const formData = new FormData(event.target);
    const settings = {
        points: {
            in_office: parseInt(formData.get('points.in_office')),
            remote: parseInt(formData.get('points.remote')),
            sick: 5,
            leave: 5
        },
        late_bonus: parseInt(formData.get('late_bonus')),
        sick_bonus: parseInt(formData.get('sick_bonus')),
        leave_bonus: parseInt(formData.get('leave_bonus')),
        remote_days: {}
    };
    
    // Collect remote days settings
    document.querySelectorAll('.user-row').forEach(row => {
        const user = row.dataset.user;
        const days = [];
        row.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            days.push(checkbox.value);
        });
        settings.remote_days[user] = days;
    });
    
    try {
        const response = await fetch('/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        if (!response.ok) throw new Error('Failed to save settings');
        
        const result = await response.json();
        alert(result.message);
        location.reload();
    } catch (error) {
        alert('Error saving settings: ' + error.message);
    }
});
</script>
{% endblock %}
