{% extends "base.html" %}
{% block title %}Connect 4{% endblock %}

{% block content %}
<div class="game-container">
    <h1>Tie Breaker: Connect 4</h1>
    <div class="game-info">
        <div class="player-info">
            <div class="player {% if game.current_player == game.player1 %}active{% endif %}">
                Player 1 (Red): {{ game.player1 }}
            </div>
            <div class="player {% if game.current_player == game.player2 %}active{% endif %}">
                Player 2 (Yellow): {{ game.player2 }}
            </div>
        </div>
        <div class="game-status">
            {% if game.winner %}
                <div class="winner">Winner: {{ game.winner }}</div>
            {% elif game.status == 'completed' %}
                <div class="draw">It's a draw!</div>
            {% else %}
                <div class="turn">Current Turn: {{ game.current_player }}</div>
            {% endif %}
        </div>
    </div>
    
    <div class="board">
        {% for row in range(6) %}
            <div class="board-row">
                {% for col in range(7) %}
                    {% set index = row * 7 + col %}
                    <div class="board-cell {% if not can_play %}view-only{% endif %}" 
                         data-col="{{ col }}"
                         data-value="{{ game.game_state.board[index] or '' }}">
                        <div class="disc"></div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
    
    {% if can_play and game.status == 'active' %}
        <button class="reset-button" onclick="resetGame()">Reset Game</button>
    {% endif %}
</div>

<style>
.game-container {
    max-width: 700px;
    margin: 0 auto;
    text-align: center;
}

.game-info {
    margin-bottom: 20px;
}

.player-info {
    display: flex;
    justify-content: space-around;
    margin-bottom: 10px;
}

.player {
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 4px;
    width: 45%;
}

.player.active {
    border-color: var(--accent-color);
    background: var(--accent-color);
    color: white;
}

.game-status {
    margin-bottom: 20px;
    font-size: 1.2em;
}

.board {
    display: inline-block; /* Changed from grid to inline-block */
    background: #2196F3;
    padding: 10px;
    border-radius: 8px;
    margin: 0 auto 20px;
}

.board-row {
    display: flex; /* Changed from grid to flex */
    gap: 5px;
    margin-bottom: 5px; /* Added margin between rows */
}

.board-row:last-child {
    margin-bottom: 0; /* Remove margin from last row */
}

.board-cell {
    width: 60px;
    height: 60px;
    background: white;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    flex: 0 0 auto; /* Prevent cell stretching */
}

.board-cell .disc {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    transition: background-color 0.3s;
}

.board-cell[data-value="view-only"] {
    cursor: default;
}

.board-cell[data-value="{{ game.player1 }}"] .disc {
    background-color: #ff4444;
}

.board-cell[data-value="{{ game.player2 }}"] .disc {
    background-color: #ffeb3b;
}

.board-cell:not([data-value=""]):hover {
    cursor: not-allowed;
}

.board-cell:hover:not([data-value]):not(.view-only) .disc {
    background-color: rgba(0,0,0,0.1);
}

.reset-button {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    background: var(--accent-color);
    color: white;
    cursor: pointer;
    transition: background 0.3s;
}

.reset-button:hover {
    background: var(--primary-color);
}

.winner {
    color: #4CAF50;
    font-weight: bold;
}

.draw {
    color: #FF9800;
    font-weight: bold;
}
</style>

{% if can_play and game.status == 'active' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if ({{ can_play|tojson }} && '{{ game.status }}' === 'active') {
        // Add click handlers to columns instead of cells
        const columns = Array.from(Array(7).keys());
        columns.forEach(col => {
            const cells = document.querySelectorAll(`.board-cell[data-col="${col}"]`);
            cells.forEach(cell => {
                cell.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (isValidMove(col)) {
                        makeMove(col);
                    }
                });
            });
        });
    }
});

function isValidMove(col) {
    // Check if column has empty spaces
    const cells = document.querySelectorAll(`.board-cell[data-col="${col}"]`);
    return Array.from(cells).some(cell => !cell.dataset.value);
}

function makeMove(col) {
    if (col === undefined || col < 0 || col > 6) return;  // Validate column

    fetch(`/games/{{ game.id }}/move`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            move: parseInt(col),
            game_type: 'connect4'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Invalid move');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to make move. Please try again.');
    });
}

// Preview move on hover
document.querySelectorAll('.board-cell').forEach(cell => {
    cell.addEventListener('mouseenter', function() {
        if ({{ can_play|tojson }} && '{{ game.status }}' === 'active') {
            const col = this.dataset.col;
            if (isValidMove(col)) {
                document.querySelectorAll(`.board-cell[data-col="${col}"]`).forEach(c => {
                    c.style.backgroundColor = 'rgba(0,0,0,0.1)';
                });
            }
        }
    });

    cell.addEventListener('mouseleave', function() {
        const col = this.dataset.col;
        document.querySelectorAll(`.board-cell[data-col="${col}"]`).forEach(c => {
            c.style.backgroundColor = '';
        });
    });
});

// Auto-refresh for spectators
{% if not can_play and game.status == 'active' %}
setInterval(() => {
    window.location.reload();
}, 5000);
{% endif %}
</script>
{% endif %}
{% endblock %}
