{% extends "base.html" %}
{% block title %}Daily Rankings{% endblock %}
{% block content %}
<h1>Rankings for {{ date }} ({{ mode|replace('-', ' ')|title }} Mode)</h1>
<div class="date-selector">
    <button onclick="changeDate(-1)">Previous Day</button>
    <input type="date" id="dateSelect" value="{{ date }}" onchange="loadDate(this.value)">
    <button onclick="changeDate(1)">Next Day</button>
</div>
<div class="rankings-container">
    <table>
        <thead>
            <tr>
                <th>Position</th>
                <th>Name</th>
                <th>Time</th>
                <th>Status</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in rankings %}
            <tr class="rank-row {% if entry.status == 'in-office' %}in-office{% endif %}">
                <td>{{ loop.index }}</td>
                <td>{{ entry.name }}</td>
                <td>{{ entry.time }}</td>
                <td>{{ entry.status }}</td>
                <td>{{ entry.points }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div class="timeline-container">
    <h2>Daily Schedule Timeline</h2>
    <div class="timeline-scale">
        {% for hour in range(7, 20) %}
            <span>{{ "%02d:00"|format(hour) }}</span>
        {% endfor %}
    </div>
    <div class="timeline-grid">
        {% for entry in rankings %}
        <div class="timeline-row">
            <span class="timeline-name">{{ entry.name }}</span>
            <div class="timeline-bar-container">
                <div class="timeline-bar" 
                     style="left: {{ ((entry.time_obj.hour * 60 + entry.time_obj.minute - 420) / 720) * 100 }}%; 
                            width: {{ (entry.shift_length / 720) * 100 }}%"
                     title="{{ entry.name }}: {{ entry.time }} - {{ entry.end_time }}">
                    <span class="timeline-time">{{ entry.time }}</span>
                    <span class="timeline-end-time">{{ entry.end_time }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script>
function changeDate(delta) {
    const dateInput = document.getElementById('dateSelect');
    const currentDate = new Date(dateInput.value);
    currentDate.setDate(currentDate.getDate() + delta);
    dateInput.value = currentDate.toISOString().split('T')[0];
    loadDate(dateInput.value);
}
function loadDate(date) {
    window.location.href = `/rankings/day/${date}`;
}

// Add timeline scaling function
function adjustTimelineBars() {
    const bars = document.querySelectorAll('.timeline-bar');
    const container = document.querySelector('.timeline-bar-container');
    const containerWidth = container.offsetWidth;
    
    bars.forEach(bar => {
        // Ensure times are visible
        const startTime = bar.querySelector('.timeline-time');
        const endTime = bar.querySelector('.timeline-end-time');
        const barWidth = bar.offsetWidth;
        
        if (barWidth < 80) { // If bar is too narrow
            startTime.style.fontSize = '0.7em';
            endTime.style.fontSize = '0.7em';
            if (barWidth < 60) {
                endTime.style.display = 'none';
                if (barWidth < 40) {
                    startTime.style.display = 'none';
                }
            }
        }
    });
}

// Call on load and resize
window.addEventListener('load', adjustTimelineBars);
window.addEventListener('resize', adjustTimelineBars);
</script>
<style>
.date-selector {
    margin: 20px 0;
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
}
.rankings-container {
    margin-top: 20px;
}
.rank-row.in-office {
    font-weight: bold;
}
.timeline-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-top: 30px;
}
.timeline-scale {
    display: grid;
    grid-template-columns: repeat(13, 1fr); /* 13 hours: 7:00 to 19:00 */
    margin-bottom: 10px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
}

.timeline-scale span {
    font-size: 0.8em;
    color: #666;
    text-align: center;
    position: relative;
}

.timeline-scale span::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 50%;
    width: 1px;
    height: 5px;
    background: #eee;
}

.timeline-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.timeline-row {
    display: flex;
    align-items: center;
    height: 40px;
}
.timeline-name {
    width: 120px;
    font-size: 0.9em;
    padding-right: 10px;
}
.timeline-bar-container {
    position: relative;
    flex-grow: 1;
    height: 25px;
    background: #f5f5f5;
    border-radius: 4px;
    background-image: linear-gradient(90deg, #eee 1px, transparent 1px);
    background-size: calc(100% / 12) 100%; /* 12 intervals for 13 hours */
}
.timeline-bar {
    position: absolute;
    height: 100%;
    background: var(--accent-color);
    border-radius: 4px;
    transition: all 0.3s ease;
    min-width: 30px; /* Minimum width for very short periods */
}
.timeline-bar:hover {
    transform: scaleY(1.1);
    z-index: 1;
}
.timeline-time, .timeline-end-time {
    position: absolute;
    font-size: 0.8em;
    color: white;
    top: 50%;
    transform: translateY(-50%);
    padding: 0 5px;
    white-space: nowrap;
    text-shadow: 0 0 2px rgba(0,0,0,0.5);
}
.timeline-time {
    left: 5px;
}
.timeline-end-time {
    right: 5px;
}
</style>
{% endblock %}