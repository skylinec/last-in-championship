{% extends "base.html" %}
{% block title %}Tic-tac-toe{% endblock %}

{% block content %}
<div class="game-container">
    <h1>Tie Breaker: Tic-tac-toe</h1>
    <div class="game-info">
        <div class="player-info">
            <div class="player {% if game.current_player == game.player1 %}active{% endif %}">
                Player 1 (X): {{ game.player1 }}
            </div>
            <div class="player {% if game.current_player == game.player2 %}active{% endif %}">
                Player 2 (O): {{ game.player2 }}
            </div>
        </div>
        <div class="game-status">
            {% if game.winner %}
                <div class="winner">Winner: {{ game.winner }}</div>
            {% elif game.status == 'completed' %}
                <div class="draw">It's a draw!</div>
            {% else %}
                <div class="turn">Current Turn: {{ game.current_player }}</div>
            {% endif %}
        </div>
    </div>
    <div class="board">
        {% for row in range(3) %}
            <div class="board-row">
                {% for col in range(3) %}
                    {% set index = row * 3 + col %}
                    <div class="board-cell {% if not can_play %}view-only{% endif %}" 
                         data-pos="{{ index }}"
                         data-value="{{ game.game_state.board[index] or '' }}">
                        {{ game.game_state.board[index] or '' }}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
    {% if can_play and game.status == 'active' %}
        <button class="reset-button" onclick="resetGame()">Reset Game</button>
    {% endif %}
</div>

<style>
.game-container {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
}

.game-info {
    margin-bottom: 20px;
}

.player-info {
    display: flex;
    justify-content: space-around;
    margin-bottom: 10px;
}

.player {
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 4px;
    width: 45%;
}

.player.active {
    border-color: var(--accent-color);
    background: var(--accent-color);
    color: white;
}

.game-status {
    margin-bottom: 20px;
    font-size: 1.2em;
}

.board {
    display: inline-block; /* Changed from grid to inline-block */
    margin: 0 auto 20px;
}

.board-row {
    display: flex; /* Changed from contents to flex */
    gap: 5px;
    margin-bottom: 5px; /* Added margin between rows */
}

.board-row:last-child {
    margin-bottom: 0; /* Remove margin from last row */
}

.board-cell {
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2em;
    border: 2px solid #ddd;
    cursor: pointer;
    transition: background 0.3s;
    flex: 0 0 auto; /* Prevent cell stretching */
}

.board-cell:hover {
    background: #f0f0f0;
}

.board-cell.view-only {
    cursor: default;
}

.reset-button {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    background: var(--accent-color);
    color: white;
    cursor: pointer;
    transition: background 0.3s;
}

.reset-button:hover {
    background: var(--primary-color);
}

/* Add responsive styles */
@media (max-width: 768px) {
    .game-container {
        padding: 10px;
    }

    .board-cell {
        width: 80px;
        height: 80px;
        font-size: 1.5em;
    }

    .player-info {
        flex-direction: column;
        gap: 10px;
    }

    .player {
        width: 100%;
    }

    .game-status {
        font-size: 1em;
    }

    .board {
        transform: scale(0.9);
        margin: 0 auto;
    }
}

@media (max-width: 480px) {
    .board-cell {
        width: 60px;
        height: 60px;
        font-size: 1.2em;
    }

    .board {
        transform: scale(0.8);
    }
}
</style>

{% if can_play and game.status == 'active' %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Connect to WebSocket server
    const socket = io();
    
    // Join the game room
    socket.emit('join_game', { game_id: {{ game.id }} });
    
    // Listen for game updates
    socket.on('game_update', function(data) {
        // Update the board
        const cells = document.querySelectorAll('.board-cell');
        data.state.board.forEach((value, index) => {
            const cell = cells[index];
            if (cell) {
                cell.dataset.value = value || '';
                cell.textContent = value || '';
            }
        });
        
        // Update turn indicator
        const turnDiv = document.querySelector('.turn');
        if (turnDiv) {
            turnDiv.textContent = `Current Turn: ${data.current_player}`;
        }
        
        // Check for winner
        if (data.winner) {
            if (data.winner === 'draw') {
                alert("Game ended in a draw! A new game will start with reversed player order.");
                window.location.reload();
            } else {
                alert(`${data.winner} wins!`);
                window.location.reload();
            }
        }
    });
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        socket.emit('leave_game', { game_id: {{ game.id }} });
    });
    
    // ...rest of existing game logic...
    
    if ({{ can_play|tojson }} && '{{ game.status }}' === 'active') {
        const cells = document.querySelectorAll('.board-cell');
        cells.forEach(cell => {
            cell.addEventListener('click', function(e) {
                e.preventDefault();  // Prevent any default action
                if (!this.dataset.value) {  // Check if cell is empty
                    makeMove(this.dataset.pos);
                }
            });
        });
    }
});

function makeMove(pos) {
    if (!pos && pos !== 0) return;  // Validate position

    fetch(`/games/{{ game.id }}/move`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            move: parseInt(pos),
            game_type: 'tictactoe'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.winner === 'draw') {
                alert("Game ended in a draw! A new game will start with reversed player order.");
                // Redirect to the new game
                if (data.next_game) {
                    window.location.href = `/games/${data.next_game}`;
                } else {
                    window.location.reload();
                }
            } else if (data.winner) {
                alert(`${data.winner} wins!`);
                window.location.reload();
            } else {
                window.location.reload();
            }
        } else {
            alert(data.message || 'Invalid move');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Server error. Please try again.');
    });
}
</script>
{% endif %}
{% endblock %}