{% extends "base.html" %}
{% block title %}Log Attendance{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="attendance-form-container">
        <h1>Log Attendance</h1>
        <form id="logForm" class="modern-form">
            <div class="form-group">
                <label for="status">Status</label>
                <div class="status-buttons">
                    <input type="radio" id="in-office" name="status" value="in-office" checked>
                    <label for="in-office" class="status-button">üè¢ In Office</label>
                    
                    <input type="radio" id="remote" name="status" value="remote">
                    <label for="remote" class="status-button">üè† Remote</label>
                    
                    <input type="radio" id="sick" name="status" value="sick">
                    <label for="sick" class="status-button">ü§í Sick</label>
                    
                    <input type="radio" id="leave" name="status" value="leave">
                    <label for="leave" class="status-button">‚úàÔ∏è Leave</label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="date" id="date" name="date" required>
                </div>

                <div class="form-group" id="timeInput">
                    <label for="time">Time Started</label>
                    <input type="time" id="time" name="time" required>
                </div>
            </div>

            <div class="form-group">
                <label for="name">Name</label>
                <input type="text" 
                       id="name" 
                       name="name" 
                       list="namesList" 
                       value="{{ session.user }}"
                       autocomplete="off"
                       required>
                <datalist id="namesList"></datalist>
            </div>

            <button type="submit" class="submit-button">Submit Attendance</button>
        </form>
    </div>

    <div class="podium-container">
        <div class="podium-controls">
            <select id="podiumPeriod">
                <option value="day">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
        <div class="podium">
            <div class="podium-place" id="second">
                <div class="trophy">ü•à</div>
                <div class="platform" style="height: 70px">2</div>
            </div>
            <div class="podium-place" id="first">
                <div class="trophy">üèÜ</div>
                <div class="platform" style="height: 100px">1</div>
            </div>
            <div class="podium-place" id="third">
                <div class="trophy">ü•â</div>
                <div class="platform" style="height: 40px">3</div>
            </div>
        </div>
        <div class="podium-names">
            <div id="secondName">-</div>
            <div id="firstName">-</div>
            <div id="thirdName">-</div>
        </div>
        <div class="podium-points">
            <div id="secondPoints">-</div>
            <div id="firstPoints">-</div>
            <div id="thirdPoints">-</div>
        </div>
    </div>
</div>

<style>
.dashboard-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.attendance-form-container {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modern-form {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 500;
    color: var(--primary-color);
}

.form-group input:not([type="radio"]) {
    padding: 12px;
    border: 2px solid #e1e1e1;
    border-radius: 6px;
    font-size: 16px;
    transition: all 0.3s ease;
}

.form-group input:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.status-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.status-buttons input[type="radio"] {
    display: none;
}

.status-button {
    padding: 12px;
    text-align: center;
    background: #f8f9fa;
    border: 2px solid #e1e1e1;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.status-buttons input[type="radio"]:checked + .status-button {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.submit-button {
    background: var(--accent-color);
    color: white;
    padding: 14px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 10px;
}

.submit-button:hover {
    background: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.quick-action-buttons {
    display: none;
}
</style>

<script>
async function updatePodium() {
    const period = document.getElementById('podiumPeriod').value;
    const response = await fetch(`/rankings/${period}`);
    const data = await response.text();
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(data, 'text/html');
    const rows = doc.querySelectorAll('tr');
    
    const places = ['first', 'second', 'third'];
    places.forEach((place, index) => {
        if (rows[index + 1]) {
            const cells = rows[index + 1].cells;
            document.getElementById(`${place}Name`).textContent = cells[0].textContent;
            document.getElementById(`${place}Points`).textContent = cells[1].textContent;
        } else {
            document.getElementById(`${place}Name`).textContent = '-';
            document.getElementById(`${place}Points`).textContent = '-';
        }
    });
}

document.getElementById('podiumPeriod').addEventListener('change', updatePodium);
document.addEventListener('DOMContentLoaded', updatePodium);
async function loadNames() {
    const response = await fetch('/names');
    const names = await response.json();
    const dataList = document.getElementById('namesList');
    dataList.innerHTML = names
        .map(name => `<option value="${name}">`)
        .join('');
}

async function clockIn(status) {
    const now = new Date();
    const data = {
        date: now.toISOString().split('T')[0],
        time: now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
        name: '{{ session.user }}',
        status: status
    };
    
    try {
        const response = await fetch('/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('result');
        resultDiv.innerText = result.message;
        resultDiv.className = `message ${result.type}`;
        resultDiv.style.display = 'block';
        
        if (result.type === 'success') {
            document.getElementById('clockInButton').disabled = true;
            document.getElementById('clockInRemoteButton').disabled = true;
            document.querySelectorAll('.quick-action-button').forEach(button => {
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
                button.title = 'Already clocked in today';
            });
        }
        
        setTimeout(() => {
            resultDiv.style.display = 'none';
        }, 5000);
    } catch (error) {
        console.error('Error:', error);
    }
}

document.querySelectorAll('input[name="status"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const timeInput = document.getElementById('timeInput');
        if (this.value === 'sick' || this.value === 'leave') {
            timeInput.style.display = 'none';
        } else {
            timeInput.style.display = 'block';
        }
    });
});

document.getElementById('date').valueAsDate = new Date();
document.getElementById('time').value = new Date().toLocaleTimeString('en-GB', { 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: false 
});

document.getElementById('logForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    const formData = {
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        name: document.getElementById('name').value,
        status: document.getElementById('status').value
    };
    
    try {
        const response = await fetch('/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('result');
        resultDiv.innerText = result.message;
        resultDiv.className = `message ${result.type}`;
        resultDiv.style.display = 'block';
        
        if (result.type === 'success') {
            document.getElementById('logForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('time').value = new Date().toLocaleTimeString('en-GB', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            document.getElementById('name').value = '{{ session.user }}';
        }
        
        setTimeout(() => {
            resultDiv.style.display = 'none';
        }, 5000);
    } catch (error) {
        console.error('Error:', error);
    }
});

document.addEventListener('DOMContentLoaded', async () => {
    loadNames();
    
    const response = await fetch('/today-entries');
    const entries = await response.json();
    const username = '{{ session.user }}';
    
    if (entries.some(e => e.name === username)) {
        document.querySelectorAll('.quick-action-button').forEach(button => {
            button.disabled = true;
            button.style.opacity = '0.5';
            button.style.cursor = 'not-allowed';
            button.title = 'Already clocked in today';
        });
    }
});
</script>
{% endblock %}