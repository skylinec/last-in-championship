{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<h1>Championship Settings</h1>

<div class="settings-container">
    <!-- Left column: Settings controls -->
    <div class="settings-column">
        <form id="settingsForm">
            <div class="settings-section">
                <h2>Points & Bonuses</h2>
                <!-- Basic point settings -->
                <div class="form-group">
                    <label for="in_office">In Office Points:</label>
                    <input type="number" id="in_office" name="points.in_office" value="{{ settings.points.in_office }}" min="0" max="20">
                </div>
                <div class="form-group">
                    <label for="remote">Remote Work Points:</label>
                    <input type="number" id="remote" name="points.remote" value="{{ settings.points.remote }}" min="0" max="20">
                </div>
                <div class="form-group">
                    <label for="late_bonus">Late Arrival Bonus:</label>
                    <input type="number" id="late_bonus" name="late_bonus" value="{{ settings.late_bonus }}" min="0" max="5">
                </div>
                <div class="form-group">
                    <label for="sick">Sick Day Points:</label>
                    <input type="number" id="sick" name="points.sick" value="{{ settings.points.sick }}" min="0" max="20">
                </div>
                <div class="form-group">
                    <label for="leave">Annual Leave Points:</label>
                    <input type="number" id="leave" name="points.leave" value="{{ settings.points.leave }}" min="0" max="20">
                </div>
            </div>

            <div class="settings-section">
                <h2>Remote Work Configuration</h2>
                <p class="helper-text">Select days when remote workers can earn position bonus points</p>
                <div class="remote-days-table">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in core_users %}
                            <tr class="user-row" data-user="{{ user }}">
                                <td>{{ user }}</td>
                                {% for day in ['mon', 'tue', 'wed', 'thu', 'fri'] %}
                                <td>
                                    <input type="checkbox" 
                                           name="remote_days.{{ user }}"
                                           value="{{ day }}"
                                           {% if day in settings.remote_days.get(user, []) %}checked{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="settings-section">
                <h2>Core Users</h2>
                <p class="helper-text">Select users to include in attendance tracking</p>
                <div class="core-users-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Registered User</th>
                                <th>Core Member</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registered_user in registered_users %}
                            <tr>
                                <td>{{ registered_user }}</td>
                                <td>
                                    <input type="checkbox" 
                                           class="core-user-checkbox"
                                           name="core_users"
                                           value="{{ registered_user }}"
                                           {% if registered_user in core_users %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="settings-section">
                <h2>Streak Settings</h2>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable_streaks" name="enable_streaks" 
                               {% if settings.enable_streaks %}checked{% endif %}>
                        Enable Streak Bonus System
                    </label>
                </div>
                
                <div class="form-group streak-settings" {% if not settings.enable_streaks %}style="display: none"{% endif %}>
                    <label for="streak_multiplier">Streak Multiplier (points per day):</label>
                    <input type="number" id="streak_multiplier" name="streak_multiplier" 
                           value="{{ settings.streak_multiplier }}" min="0" max="5" step="0.1">
                </div>
            </div>

            <button type="submit" class="save-button">Save All Settings</button>
        </form>
    </div>

    <!-- Right column: Scoring explanation -->
    <div class="info-column">
        <div class="scoring-explanation">
            <h2>How Scoring Works</h2>
            <div class="mode-specific-info">
                <h3>Position Bonus System</h3>
                <div id="lastInInfo">
                    <h4>Last-In Championship Mode</h4>
                    <p>Points increase with later arrival times:</p>
                    <ul>
                        <li>Last person to arrive gets maximum bonus (position × {{ settings.late_bonus }})</li>
                        <li>Earlier arrivals get progressively smaller bonuses</li>
                        <li>First arrival gets minimum position bonus</li>
                    </ul>
                </div>
                <div id="earlyBirdInfo" style="display: none;">
                    <h4>Early Bird Mode</h4>
                    <p>Points increase with earlier arrival times:</p>
                    <ul>
                        <li>First person to arrive gets maximum bonus (position × {{ settings.late_bonus }})</li>
                        <li>Later arrivals get progressively smaller bonuses</li>
                        <li>Last arrival gets minimum position bonus</li>
                    </ul>
                </div>
            </div>

            <div class="example-box">
                <h4>Base Points</h4>
                <ul>
                    <li>In-office: {{ settings.points.in_office }} points</li>
                    <li>Remote work: {{ settings.points.remote }} points</li>
                    <li>Sick leave: {{ settings.points.sick }} points</li>
                    <li>Annual leave: {{ settings.points.leave }} points</li>
                </ul>
            </div>

            <div class="example-box">
                <h4>Example Calculations</h4>
                <div id="lastInExample">
                    <h5>Last-In Mode Example (5 people)</h5>
                    <table class="example-table">
                        <tr><th>Position</th><th>Calculation</th><th>Total</th></tr>
                        <tr>
                            <td>Last (5th)</td>
                            <td>{{ settings.points.in_office }} + (5 × {{ settings.late_bonus }})</td>
                            <td>{{ settings.points.in_office + (5 * settings.late_bonus) }}</td>
                        </tr>
                        <tr>
                            <td>First</td>
                            <td>{{ settings.points.in_office }} + (1 × {{ settings.late_bonus }})</td>
                            <td>{{ settings.points.in_office + settings.late_bonus }}</td>
                        </tr>
                    </table>
                </div>
                <div id="earlyBirdExample" style="display: none;">
                    <h5>Early Bird Mode Example (5 people)</h5>
                    <table class="example-table">
                        <tr><th>Position</th><th>Calculation</th><th>Total</th></tr>
                        <tr>
                            <td>First</td>
                            <td>{{ settings.points.in_office }} + (5 × {{ settings.late_bonus }})</td>
                            <td>{{ settings.points.in_office + (5 * settings.late_bonus) }}</td>
                        </tr>
                        <tr>
                            <td>Last (5th)</td>
                            <td>{{ settings.points.in_office }} + (1 × {{ settings.late_bonus }})</td>
                            <td>{{ settings.points.in_office + settings.late_bonus }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Replace existing streak explanation with updated one -->
            {% if settings.enable_streaks %}
            <div class="example-box streak-explanation">
                <h4>Streak System</h4>
                <p>The streak system rewards consistent attendance with bonus points:</p>
                <ul>
                    <li>Each consecutive workday earns additional points</li>
                    <li>Current multiplier: {{ settings.streak_multiplier }} points per day in streak</li>
                    <li>Weekend days don't break streaks</li>
                    <li>Both office and remote work count towards streaks</li>
                    <li>Sick days or annual leave break the streak</li>
                </ul>
                
                <div class="streak-example">
                    <h5>Example Streak Calculation</h5>
                    <table class="example-table">
                        <tr>
                            <th>Scenario</th>
                            <th>Streak</th>
                            <th>Bonus Points</th>
                        </tr>
                        <tr>
                            <td>Mon (Office) → Tue (Office)</td>
                            <td>2 days</td>
                            <td>{{ 2 * settings.streak_multiplier }}</td>
                        </tr>
                        <tr>
                            <td>Thu (Office) → Fri (Remote) → Mon (Office)</td>
                            <td>3 days</td>
                            <td>{{ 3 * settings.streak_multiplier }}</td>
                        </tr>
                        <tr>
                            <td>Mon (Office) → Tue (Sick) → Wed (Office)</td>
                            <td>1 day</td>
                            <td>{{ 1 * settings.streak_multiplier }}</td>
                        </tr>
                    </table>
                </div>

                <div class="streak-notes">
                    <h5>Important Notes</h5>
                    <ul>
                        <li>Streaks are counted backwards from each attendance</li>
                        <li>Maximum gap allowed is 3 days (to account for weekends)</li>
                        <li>Streak bonus is added to both early-bird and last-in scores</li>
                        <li>Streaks reset after any non-working day (except weekends)</li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.settings-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.settings-column {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.info-column {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

.settings-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.settings-section:last-child {
    border-bottom: none;
}

.remote-days-table {
    margin: 20px 0;
    overflow-x: auto;
}

.remote-days-table table {
    width: 100%;
    border-collapse: collapse;
}

.remote-days-table td {
    text-align: center;
    padding: 10px;
}

.remote-days-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
}

.helper-text {
    color: #666;
    font-size: 0.9em;
    margin: 5px 0 15px;
}

/* ...existing styles... */

.example-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin: 15px 0;
}

.example-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

.example-table th {
    background: var(--primary-color);
    color: white;
    padding: 8px;
}

.example-table td {
    padding: 8px;
    border-bottom: 1px solid #dee2e6;
}

.example-box .calculation {
    font-family: monospace;
    background: #e9ecef;
    padding: 2px 6px;
    border-radius: 4px;
}

.scoring-explanation {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.scoring-explanation ul {
    list-style-type: none;
    padding-left: 20px;
}

.scoring-explanation ul li {
    margin: 8px 0;
    position: relative;
}

.scoring-explanation ul li::before {
    content: "•";
    color: var(--accent-color);
    font-weight: bold;
    position: absolute;
    left: -15px;
}

.remote-days-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
    margin: 0;
    padding: 0;
}

.remote-days-table th {
    padding: 12px;
    text-align: center;
    background: var(--primary-color);
    color: white;
}

.remote-days-table td {
    text-align: center;
    padding: 12px;
    border: 1px solid #dee2e6;
}

.remote-days-table tr:nth-child(even) {
    background: #f8f9fa;
}

.remote-days-table tr:hover {
    background: #e9ecef;
}

.core-users-table {
    margin: 20px 0;
    overflow-x: auto;
}

.core-users-table table {
    width: 100%;
    border-collapse: collapse;
}

.core-users-table td {
    text-align: left;
    padding: 10px;
}

.core-users-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
}

.streak-example {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
}

.streak-example h5 {
    margin-top: 0;
    color: var(--primary-color);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update mode-specific info based on championship toggle
    function updateModeInfo() {
        const isLastIn = document.getElementById('championshipToggle').checked;
        document.getElementById('lastInInfo').style.display = isLastIn ? 'block' : 'none';
        document.getElementById('earlyBirdInfo').style.display = isLastIn ? 'none' : 'block';
        document.getElementById('lastInExample').style.display = isLastIn ? 'block' : 'none';
        document.getElementById('earlyBirdExample').style.display = isLastIn ? 'none' : 'block';
    }

    // Initial update
    updateModeInfo();

    // Listen for mode changes
    document.getElementById('championshipToggle').addEventListener('change', updateModeInfo);
});

document.getElementById('settingsForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    
    // Collect basic settings
    const formData = new FormData(event.target);
    const settings = {
        points: {
            in_office: parseInt(formData.get('points.in_office')),
            remote: parseInt(formData.get('points.remote')),
            sick: parseInt(formData.get('points.sick')),
            leave: parseInt(formData.get('points.leave'))
        },
        late_bonus: parseInt(formData.get('late_bonus')),
        remote_days: {},
        core_users: Array.from(document.querySelectorAll('.core-user-checkbox:checked'))
                       .map(checkbox => checkbox.value),
        enable_streaks: document.getElementById('enable_streaks').checked,
        streak_multiplier: parseFloat(document.getElementById('streak_multiplier').value)
    };
    
    // Collect remote days settings
    document.querySelectorAll('.user-row').forEach(row => {
        const user = row.dataset.user;
        const days = [];
        row.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            days.push(checkbox.value);
        });
        settings.remote_days[user] = days;
    });
    
    try {
        const response = await fetch('/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        if (!response.ok) throw new Error('Failed to save settings');
        
        const result = await response.json();
        alert(result.message);
        location.reload();
    } catch (error) {
        alert('Error saving settings: ' + error.message);
    }
});

document.getElementById('enable_streaks').addEventListener('change', function() {
    const streakSettings = document.querySelector('.streak-settings');
    const streakExplanation = document.getElementById('streakExplanation');
    streakSettings.style.display = this.checked ? 'block' : 'none';
    streakExplanation.style.display = this.checked ? 'block' : 'none';
});
</script>
{% endblock %}
