{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<h1>Championship Settings</h1>

<div class="settings-container">
    <!-- Left column: Settings controls -->
    <div class="settings-column">
        <form id="settingsForm" method="POST" action="/settings">
            <input type="hidden" name="rules" id="rulesInput" />
            <input type="hidden" id="rulesJson" value='{{ rules|tojson|safe }}' />
            <div class="settings-section">
                <h2>Points & Bonuses</h2>
                <!-- Basic point settings -->
                <div class="form-group">
                    <label for="in_office">In Office Points:</label>
                    <input type="number" id="in_office" name="points.in_office" value="{{ settings.points.in_office }}" min="0" max="20">
                </div>
                <div class="form-group">
                    <label for="remote">Remote Work Points:</label>
                    <input type="number" id="remote" name="points.remote" value="{{ settings.points.remote }}" min="0" max="20">
                </div>
                <div class="form-group">
                    <label for="late_bonus">Late Arrival Bonus:</label>
                    <input type="number" id="late_bonus" name="late_bonus" value="{{ settings.late_bonus }}" min="0" max="5">
                </div>
                <div class="form-group">
                    <label for="sick">Sick Day Points:</label>
                    <input type="number" id="sick" name="points.sick" value="{{ settings.points.sick }}" min="0" max="20">
                </div>
                <div class="form-group">
                    <label for="leave">Annual Leave Points:</label>
                    <input type="number" id="leave" name="points.leave" value="{{ settings.points.leave }}" min="0" max="20">
                </div>
            </div>

            <div class="settings-section">
                <h2>Remote Work Configuration</h2>
                <p class="helper-text">Select days when remote workers can earn position bonus points</p>
                <div class="remote-days-table">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in core_users %}
                            <tr class="user-row" data-user="{{ user }}">
                                <td>{{ user }}</td>
                                {% for day in ['mon', 'tue', 'wed', 'thu', 'fri'] %}
                                <td>
                                    <input type="checkbox" 
                                           name="remote_days.{{ user }}"
                                           value="{{ day }}"
                                           {% if day in settings.remote_days.get(user, []) %}checked{% endif %}>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="settings-section">
                <h2>Core Users</h2>
                <p class="helper-text">Select users to include in attendance tracking</p>
                <div class="core-users-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Registered User</th>
                                <th>Core Member</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registered_user in registered_users %}
                            <tr>
                                <td>{{ registered_user }}</td>
                                <td>
                                    <input type="checkbox" 
                                           class="core-user-checkbox"
                                           name="core_users"
                                           value="{{ registered_user }}"
                                           {% if registered_user in core_users %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="settings-section">
                <h2>Streak & Tie Breaker Settings</h2>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable_streaks" name="enable_streaks" 
                               {% if settings.enable_streaks %}checked{% endif %}>
                        Enable Streak Bonus System
                    </label>
                </div>
                
                <div class="form-group streak-settings" {% if not settings.enable_streaks %}style="display: none"{% endif %}>
                    <label for="streak_multiplier">Streak Multiplier (points per day):</label>
                    <input type="number" id="streak_multiplier" name="streak_multiplier" 
                           value="{{ settings.streak_multiplier }}" min="0" max="5" step="0.1">
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable_tiebreakers" name="enable_tiebreakers" 
                               {% if settings.enable_tiebreakers %}checked{% endif %}>
                        Enable Tie Breaker System
                    </label>
                </div>

                <div class="form-group tiebreaker-settings" {% if not settings.enable_tiebreakers %}style="display: none"{% endif %}>
                    <label for="tiebreaker_points">Tie Breaker Win Points:</label>
                    <input type="number" id="tiebreaker_points" name="tiebreaker_points" 
                           value="{{ settings.tiebreaker_points|default(5) }}" min="1" max="20" step="1">
                    <p class="helper-text">Points awarded to tie breaker winners</p>

                    <label for="tiebreaker_expiry">Tie Breaker Expiry (hours):</label>
                    <input type="number" id="tiebreaker_expiry" name="tiebreaker_expiry" 
                           value="{{ settings.tiebreaker_expiry|default(24) }}" min="1" max="72">
                    <p class="helper-text">Time allowed for players to complete tie breakers</p>

                    <label class="checkbox-label">
                        <input type="checkbox" id="auto_resolve_tiebreakers" name="auto_resolve_tiebreakers" 
                               {% if settings.auto_resolve_tiebreakers %}checked{% endif %}>
                        Automatically Resolve Expired Tie Breakers
                    </label>
                    <p class="helper-text">If enabled, expired tie breakers will be resolved randomly</p>
                    
                    <h4>Tie Breaker Generation</h4>
                    <label class="checkbox-label">
                        <input type="checkbox" id="tiebreaker_weekly" name="tiebreaker_weekly" 
                               {% if settings.tiebreaker_weekly %}checked{% endif %}>
                        Generate tie breakers at the end of each week
                    </label>
                    <p class="helper-text">When enabled, tie breakers will be created for tied weekly rankings on Sundays</p>

                    <label class="checkbox-label">
                        <input type="checkbox" id="tiebreaker_monthly" name="tiebreaker_monthly" 
                               {% if settings.tiebreaker_monthly %}checked{% endif %}>
                        Generate tie breakers at the end of each month
                    </label>
                    <p class="helper-text">When enabled, tie breakers will be created for tied monthly rankings on the last day of each month</p>
                </div>
            </div>

            <div class="settings-section">
                <h2>Scoring Rules Editor</h2>
                <button type="button" class="open-rules-editor">Open Rules Editor</button>
            </div>

            <div class="settings-section">
                <h2>Schedule Configuration</h2>
                <div class="form-group">
                    <label for="shift_length">Default Shift Length (hours):</label>
                    <input type="number" id="shift_length" name="points.shift_length" 
                           value="{{ settings.points.shift_length|default(9) }}" min="4" max="12" step="0.5">
                    <p class="helper-text">Default shift length when no day-specific length is set</p>
                </div>

                <h3>Daily Shift Lengths</h3>
                <p class="helper-text">Configure different shift lengths for specific days</p>
                <div class="shift-lengths-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Hours</th>
                                <th>Start Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] %}
                            <tr>
                                <td>{{ day }}</td>
                                <td>
                                    <input type="number" 
                                           name="points.daily_shifts.{{ day|lower }}.hours"
                                           value="{{ settings.points.get('daily_shifts', {}).get(day|lower, {}).get('hours', settings.points.shift_length|default(9)) }}"
                                           min="3" max="9" step="0.5">
                                </td>
                                <td>
                                    <input type="time"
                                           name="points.daily_shifts.{{ day|lower }}.start"
                                           value="{{ settings.points.get('daily_shifts', {}).get(day|lower, {}).get('start', '09:00') }}">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="settings-section">
                <h2>Monitoring Configuration</h2>
                <div class="form-group">
                    <label for="monitoring_start_date">Check Missing Entries From:</label>
                    <input type="date" 
                           id="monitoring_start_date" 
                           name="monitoring_start_date"
                           value="{{ settings.monitoring_start_date|default(today().replace(month=1, day=1).strftime('%Y-%m-%d')) }}"
                           max="{{ today().strftime('%Y-%m-%d') }}">
                    <p class="helper-text">The system will check for missing entries starting from this date</p>
                </div>
            </div>

            <button type="submit" class="save-button">Save All Settings</button>
        </form>
    </div>

    <!-- Add Modal for Rules Editor -->
    <div id="rulesEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Scoring Rules Editor</h2>
                <span class="close">&times;</span>
            </div>

            <div class="scoring-dsl-container">
                <!-- Move scoring blocks above documentation -->
                <div class="scoring-blocks-palette">
                    <h3>Available Blocks</h3>
                    <div class="block-category">
                        <h4>Conditions</h4>
                        <div class="block" draggable="true" data-type="condition" data-template="if arrival {operator} {time}">
                            Arrival Time
                        </div>
                        <div class="block" draggable="true" data-type="condition" data-template="if working {status}">
                            Work Status
                        </div>
                        <div class="block" draggable="true" data-type="condition" data-template="if day is {day}">
                            Day Type
                        </div>
                        <div class="block" draggable="true" data-type="condition" data-template="if streak {operator} {value}">
                            Streak Length
                        </div>
                    </div>
                    <div class="block-category">
                        <h4>Actions</h4>
                        <div class="block" draggable="true" data-type="action" data-template="award {points} points">
                            Award Points
                        </div>
                        <div class="block" draggable="true" data-type="action" data-template="multiply points by {value}">
                            Apply Multiplier
                        </div>
                        <div class="block" draggable="true" data-type="action" data-template="add streak bonus">
                            Add Streak Bonus
                        </div>
                    </div>
                </div>
                
                <div class="scoring-rules-builder">
                    <h3>Current Rules</h3>
                    <div id="rulesContainer" class="rules-container scrollable-container">
                        <!-- Rules will be added here -->
                    </div>
                    <div class="rules-actions">
                        <button type="button" onclick="testRules()">Test Rules</button>
                        <button type="button" onclick="saveRules()">Save Rules</button>
                    </div>
                </div>

                <div class="scoring-preview">
                    <h3>Rule Preview</h3>
                    <pre id="rulePreview" class="rule-preview"></pre>
                    
                    <div class="test-results" style="display: none">
                        <h3>Test Results</h3>
                        <div id="testResults"></div>
                    </div>
                </div>
            </div>

            <!-- Add documentation section below the editor -->
            <div class="rules-documentation-section">
                <div class="rules-documentation scrollable-container">
                    <h3>How Rules Work</h3>
                    <p>Rules are evaluated in order from top to bottom. Each rule consists of a condition and an action.</p>
                    
                    <h4>Available Conditions:</h4>
                    <ul>
                        <li><strong>Arrival Time:</strong> Check when someone arrives (e.g., "if arrival before 09:00")</li>
                        <li><strong>Work Status:</strong> Check how they're working (e.g., "if working in-office")</li>
                        <li><strong>Day Type:</strong> Check the type of day (e.g., "if day is Monday")</li>
                        <li><strong>Streak Length:</strong> Check consecutive attendance (e.g., "if streak > 5")</li>
                    </ul>

                    <h4>Available Actions:</h4>
                    <ul>
                        <li><strong>Award Points:</strong> Add a fixed number of points</li>
                        <li><strong>Multiply Points:</strong> Multiply current points by a factor</li>
                        <li><strong>Add Streak Bonus:</strong> Add points based on streak length</li>
                    </ul>

                    <div class="rule-examples">
                        <h4>Example Rules:</h4>
                        <pre class="example-rule">
# Early Bird Bonus
if arrival before 09:00
award 2 points

# Office Attendance
if working in-office
award 10 points

# Remote Work
if working remote
award 8 points

# Long Streak Bonus
if streak > 5
multiply points by 1.5</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right column: Scoring explanation -->
    <div class="info-column">
        <div class="scoring-explanation">
            <h2>How Scoring Works</h2>
            <div class="mode-specific-info">
                <h3>Position Bonus System</h3>
                <div id="lastInInfo">
                    <h4>Last-In Championship Mode</h4>
                    <p>Last person to arrive gets maximum bonus (position × {{ settings.late_bonus }}), decreasing for earlier arrivals.</p>
                </div>
                <div id="earlyBirdInfo" style="display: none;">
                    <h4>Early Bird Mode</h4>
                    <p>First person to arrive gets maximum bonus (position × {{ settings.late_bonus }}), decreasing for later arrivals.</p>
                </div>
            </div>

            <div class="example-box">
                <h4>Base Points & Position Bonuses</h4>
                <table class="example-table">
                    <tr><th>Status</th><th>Points</th></tr>
                    {% for status in ['in_office', 'remote', 'sick', 'leave'] %}
                    <tr>
                        <td>{{ status|replace('_', ' ')|title }}</td>
                        <td>{{ settings.points[status] }}</td>
                    </tr>
                    {% endfor %}
                    <tr><td>Position Bonus</td><td>position × {{ settings.late_bonus }}</td></tr>
                </table>
            </div>

            {% if settings.enable_streaks or settings.enable_tiebreakers %}
            <div class="example-box">
                <h4>Bonus Systems</h4>
                {% if settings.enable_streaks %}
                <div class="bonus-section">
                    <h5>Streak Bonuses</h5>
                    <p>Bonuses are {{ settings.streak_multiplier }} points per consecutive day:</p>
                    <ul>
                        <li>Early Bird: +{{ settings.streak_multiplier }} × streak days</li>
                        <li>Last-In: -{{ settings.streak_multiplier }} × streak days</li>
                    </ul>
                </div>
                {% endif %}

                {% if settings.enable_tiebreakers %}
                <div class="bonus-section">
                    <h5>Tie Breakers</h5>
                    <p>{{ settings.tiebreaker_points }} points per win:</p>
                    <ul>
                        <li>Early Bird: +{{ settings.tiebreaker_points }} points</li>
                        <li>Last-In: -{{ settings.tiebreaker_points }} points</li>
                    </ul>
                    <p>Expires after {{ settings.tiebreaker_expiry }} hours{% if settings.auto_resolve_tiebreakers %} with random resolution{% endif %}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <div class="example-box">
                <h4>Schedule Configuration</h4>
                <table class="example-table">
                    <tr>
                        <th>Day</th>
                        <th>Hours</th>
                        <th>Start</th>
                        <th>End</th>
                    </tr>
                    {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] %}
                    {% set shift = settings.points.get('daily_shifts', {}).get(day|lower, {'hours': settings.points.shift_length|default(9), 'start': '09:00'}) %}
                    <tr>
                        <td>{{ day }}</td>
                        <td>{{ shift.hours }}</td>
                        <td>{{ shift.start }}</td>
                        <td>{{ (shift.start|time_to_minutes + (shift.hours * 60))|minutes_to_time }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>

</div>

<style>
.settings-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.settings-column {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.info-column {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

.settings-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.settings-section:last-child {
    border-bottom: none;
}

.remote-days-table {
    margin: 20px 0;
    overflow-x: auto;
}

.remote-days-table table {
    width: 100%;
    border-collapse: collapse;
}

.remote-days-table td {
    text-align: center;
    padding: 10px;
}

.remote-days-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
}

.helper-text {
    color: #666;
    font-size: 0.9em;
    margin: 5px 0 15px;
}

/* ...existing styles... */

.example-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin: 15px 0;
}

.example-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

.example-table th {
    background: var(--primary-color);
    color: white;
    padding: 8px;
}

.example-table td {
    padding: 8px;
    border-bottom: 1px solid #dee2e6;
}

.example-box .calculation {
    font-family: monospace;
    background: #e9ecef;
    padding: 2px 6px;
    border-radius: 4px;
}

.scoring-explanation {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.scoring-explanation ul {
    list-style-type: none;
    padding-left: 20px;
}

.scoring-explanation ul li {
    margin: 8px 0;
    position: relative;
}

scoring-explanation ul li::before {
    content: "•";
    color: var(--accent-color);
    font-weight: bold;
    position: absolute;
    left: -15px;
}

.remote-days-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
    margin: 0;
    padding: 0;
}

.remote-days-table th {
    padding: 12px;
    text-align: center;
    background: var(--primary-color);
    color: white;
}

.remote-days-table td {
    text-align: center;
    padding: 12px;
    border: 1px solid #dee2e6;
}

.remote-days-table tr:nth-child(even) {
    background: #f8f9fa;
}

.remote-days-table tr:hover {
    background: #e9ecef;
}

.core-users-table {
    margin: 20px 0;
    overflow-x: auto;
}

.core-users-table table {
    width: 100%;
    border-collapse: collapse;
}

.core-users-table td {
    text-align: left;
    padding: 10px;
}

.core-users-table input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
}

.streak-example {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
}

.streak-example h5 {
    margin-top: 0;
    color: var(--primary-color);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
}

.mode-specific {
    margin: 15px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}

.mode-specific h5 {
    color: var(--primary-color);
    margin-top: 10px;
}

.streak-rules {
    margin: 15px 0;
    padding: 10px;
    background: #e9ecef;
    border-radius: 4px;
}

.scoring-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.setting-explanation {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
}

.points-preview {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
}

.calculator {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.points-breakdown {
    font-family: monospace;
    white-space: pre-wrap;
    background: #fff;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.scoring-dsl-container {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 20px;
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.scoring-blocks-palette {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.block {
    background: var(--accent-color);
    color: white;
    padding: 10px;
    margin: 5px 0;
    border-radius: 4px;
    cursor: grab;
    user-select: none;
}

.block[data-type="condition"] {
    background: var(--primary-color);
}

.block[data-type="action"] {
    background: var(--success-color);
}

.rules-container {
    min-height: 200px;
    padding: 15px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.rule-block {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    margin: 5px 0;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px dashed #dee2e6;
}

.rule-block input, .rule-block select {
    padding: 4px;
    border-radius: 3px;
    border: 1px solid #dee2e6;
}

.rule-preview {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    white-space: pre-wrap;
    font-family: monospace;
}

.block-category {
    margin-bottom: 20px;
}

.block-category h4 {
    color: var(--primary-color);
    margin-bottom: 10px;
}

.dragging {
    opacity: 0.5;
    cursor: move;
}

.drag-over {
    border: 2px dashed var(--accent-color);
}

.rules-container {
    min-height: 100px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.rule-block {
    cursor: move;
    transition: transform 0.2s ease;
}

.rule-block:hover {
    transform: translateX(5px);
}

.rule-block button {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.rule-block:hover button {
    opacity: 1;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 1200px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-height: 90vh;
    overflow: hidden;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.open-rules-editor {
    background: var(--accent-color);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

.open-rules-editor:hover {
    background: var(--primary-color);
}

.rule-block {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: move;
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;
}

.rule-block.dragging {
    opacity: 0.5;
    background: #f0f0f0;
}

.rule-block input,
.rule-block select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.rule-block button {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #ff4444;
    cursor: pointer;
    font-size: 18px;
    opacity: 0;
    transition: opacity 0.2s;
}

.rule-block:hover button {
    opacity: 1;
}

.rules-container {
    min-height: 200px;
    border: 2px dashed #ddd;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.rules-container.drag-over {
    background: #f0f7ff;
    border-color: var(--accent-color);
}

.rule-example {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    font-family: monospace;
    margin: 10px 0;
    white-space: pre-wrap;
}

.info-section {
    margin-top: 20px;
    padding: 15px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.info-section h4 {
    color: var(--primary-color);
    margin-top: 15px;
}

.info-section ul {
    list-style-type: none;
    padding-left: 0;
}

.info-section li {
    margin: 8px 0;
    padding-left: 20px;
    position: relative;
}

.info-section li:before {
    content: "•";
    color: var(--accent-color);
    position: absolute;
    left: 0;
}

.rules-documentation {
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.rules-documentation h3 {
    color: var(--primary-color);
    margin-bottom: 10px;
}

.rules-documentation ul {
    padding-left: 20px;
}

.rules-documentation li {
    margin: 8px 0;
}

.example-rule {
    background: #fff;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    margin: 10px 0;
}

.rules-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.rules-actions button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.rules-actions button:first-child {
    background: var(--accent-color);
    color: white;
}

.rules-actions button:last-child {
    background: var(--primary-color);
    color: white;
}

.test-results {
    margin-top: 20px;
    padding: 15px;
    background: #fff;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.test-scenario {
    margin: 10px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}

.test-result {
    margin-top: 5px;
    font-family: monospace;
}

.test-result.success {
    color: #28a745;
}

.test-result.failure {
    color: #dc3545;
}

.rules-documentation-section {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 20px;
}

.scrollable-container {
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--accent-color) #f0f0f0;
}

.scrollable-container::-webkit-scrollbar {
    width: 8px;
}

.scrollable-container::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 4px;
}

.scrollable-container::-webkit-scrollbar-thumb {
    background: var(--accent-color);
    border-radius: 4px;
}

.rules-container {
    min-height: 200px;
    max-height: 300px;
    padding: 15px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.scoring-blocks-palette {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    max-height: 400px;
    overflow-y: auto;
}

.rules-documentation {
    max-height: 300px;
    padding: 15px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

<script>
function loadExistingRules() {
    const rulesJson = document.getElementById('rulesJson');
    if (rulesJson && rulesJson.value) {
        try {
            const rules = JSON.parse(rulesJson.value);
            rules.forEach(rule => {
                if (rule.type === 'condition' || rule.type === 'action') {
                    let template = buildTemplateFromRule(rule);
                    createRuleBlock(rule.type, template);
                }
            });
            updateRulePreview();
        } catch (e) {
            console.error('Error loading existing rules:', e);
        }
    }
}

function buildTemplateFromRule(rule) {
    if (rule.type === 'condition') {
        if (rule.arrival) {
            return `if arrival {operator} {time}`;
        } else if (rule.working) {
            return `if working {status}`;
        } else if (rule.day) {
            return `if day is {day}`;
        } else if (rule.streak) {
            return `if streak {operator} {value}`;
        }
    } else if (rule.type === 'action') {
        if (rule.award) {
            return `award {points} points`;
        } else if (rule.multiply) {
            return `multiply points by {value}`;
        } else if (rule.streak) {
            return `add streak bonus`;
        }
    }
    return '';
}

// Add modal handling
document.querySelector('.open-rules-editor').addEventListener('click', function() {
    const modal = document.getElementById('rulesEditorModal');
    modal.style.display = 'block';
});

document.querySelector('.close').addEventListener('click', function() {
    const modal = document.getElementById('rulesEditorModal');
    modal.style.display = 'none';
});

window.addEventListener('click', function(event) {
    const modal = document.getElementById('rulesEditorModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
});
// ...existing code...
function openRulesEditor() {
    fetch("/api/rules")
        .then(response => response.json())
        .then(rules => {
            // ...existing code...
            document.getElementById("rulesContainer").innerText = JSON.stringify(rules, null, 2);
            document.getElementById("rulePreview").innerText = JSON.stringify(rules, null, 2);
        });
}
function testRules() {
    alert("Test your rules here");
    // ...existing code...
}
function saveRules() {
    const rules = collectRulesFromEditor();
    document.getElementById('rulesInput').value = JSON.stringify(rules);
    
    // Send rules directly to the API endpoint
    fetch('/api/rules', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ rules: rules })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Server returned ' + response.status);
        }
        return response.json();
    })
    .then(result => {
        alert('Rules saved successfully!');
        document.getElementById('rulesEditorModal').style.display = 'none';
        // Reload page to show updated settings
        window.location.reload();
    })
    .catch(error => {
        console.error('Error saving rules:', error);
        alert('Error saving rules: ' + error.message);
    });
}

// Add helper function to get current settings
function load_settings() {
    const settingsData = document.getElementById('rulesJson').value;
    try {
        return JSON.parse(settingsData) || {};
    } catch (e) {
        console.error('Error parsing settings:', e);
        return {};
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Update mode-specific info based on championship toggle
    function updateModeInfo() {
        const isLastIn = document.getElementById('championshipToggle').checked;
        document.getElementById('lastInInfo').style.display = isLastIn ? 'block' : 'none';
        document.getElementById('earlyBirdInfo').style.display = isLastIn ? 'none' : 'block';
        document.getElementById('lastInExample').style.display = isLastIn ? 'block' : 'none';
        document.getElementById('earlyBirdExample').style.display = isLastIn ? 'none' : 'block';
    }

    // Initial update
    updateModeInfo();

    // Listen for mode changes
    document.getElementById('championshipToggle').addEventListener('change', updateModeInfo);
});

document.getElementById('settingsForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    
    // Get all form data
    const formData = new FormData(event.target);
    
    // Build settings object with proper nesting
    const settings = {
        points: {
            in_office: parseInt(formData.get('points.in_office')),
            remote: parseInt(formData.get('points.remote')),
            sick: parseInt(formData.get('points.sick')),
            leave: parseInt(formData.get('points.leave')),
            shift_length: parseFloat(formData.get('points.shift_length')),
            daily_shifts: {},
            rules: JSON.parse(document.getElementById('rulesInput').value || '[]'),
            working_days: {} // Preserve working days configuration
        },
        late_bonus: parseFloat(formData.get('late_bonus')),
        remote_days: {},
        core_users: Array.from(document.querySelectorAll('.core-user-checkbox:checked'))
                       .map(checkbox => checkbox.value),
        enable_streaks: document.getElementById('enable_streaks').checked,
        streak_multiplier: parseFloat(document.getElementById('streak_multiplier').value),
        monitoring_start_date: formData.get('monitoring_start_date'),
        streaks_enabled: document.getElementById('enable_streaks').checked,
        streak_bonus: parseFloat(document.getElementById('streak_multiplier').value),
        enable_tiebreakers: document.getElementById('enable_tiebreakers').checked,
        tiebreaker_points: parseInt(document.getElementById('tiebreaker_points').value),
        tiebreaker_expiry: parseInt(document.getElementById('tiebreaker_expiry').value),
        auto_resolve_tiebreakers: document.getElementById('auto_resolve_tiebreakers').checked
    };

    // Collect daily shifts
    ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].forEach(day => {
        settings.points.daily_shifts[day] = {
            hours: parseFloat(formData.get(`points.daily_shifts.${day}.hours`)) || 9,
            start: formData.get(`points.daily_shifts.${day}.start`) || '09:00'
        };
    });

    // Collect remote days
    document.querySelectorAll('.user-row').forEach(row => {
        const user = row.dataset.user;
        const days = Array.from(row.querySelectorAll('input[type="checkbox"]:checked'))
                        .map(checkbox => checkbox.value);
        settings.remote_days[user] = days;
    });

    try {
        const response = await fetch('/settings', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(settings)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText);
        }

        const result = await response.json();
        
        // Show success toast
        showToast(result.message || 'Settings saved successfully', 'success');
        
        // Force cache invalidation by adding timestamp to URL
        const timestamp = new Date().getTime();
        window.location.href = `/settings?t=${timestamp}`;
    } catch (error) {
        console.error('Error saving settings:', error);
        showToast('Error saving settings: ' + error.message, 'error');
    }
});

// Add helper functions for toast notifications
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Add toast styles if not already present
document.head.insertAdjacentHTML('beforeend', `
    <style>
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: toastIn 0.3s ease-out;
        }
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--warning-color); }
        @keyframes toastIn {
            from { transform: translate(-50%, -20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
    </style>
`);

// ...rest of existing code...
document.getElementById('enable_streaks').addEventListener('change', function() {
    const streakSettings = document.querySelector('.streak-settings');
    const streakExplanation = document.getElementById('streakExplanation');
    streakSettings.style.display = this.checked ? 'block' : 'none';
    streakExplanation.style.display = this.checked ? 'block' : 'none';
});

document.getElementById('enable_tiebreakers').addEventListener('change', function() {
    const tiebreakerSettings = document.querySelector('.tiebreaker-settings');
    tiebreakerSettings.style.display = this.checked ? 'block' : 'none';
});

function calculatePoints() {
    // Only run if we're in the calculator view
    if (!document.getElementById('position_multiplier')) {
        return; // Exit if required elements don't exist
    }

    const settings = {
        position_multiplier: parseFloat(document.getElementById('position_multiplier').value) || 0,
        early_bonus: parseFloat(document.getElementById('early_bonus').value) || 0,
        weekend_multiplier: parseFloat(document.getElementById('weekend_multiplier').value) || 1,
        holiday_multiplier: parseFloat(document.getElementById('holiday_multiplier').value) || 1,
        consecutive_days_bonus: parseFloat(document.getElementById('consecutive_days_bonus').value) || 0
    };

    const scenario = document.getElementById('scenarioSelect').value;
    const arrivalTime = document.getElementById('arrivalTime').value;
    const status = document.getElementById('statusSelect').value;
    const position = parseInt(document.getElementById('position').value);
    const streak = parseInt(document.getElementById('streak').value);

    // Calculate base points
    let points = status === 'in_office' ? settings.points.in_office : settings.points.remote;
    let breakdown = `Base points (${status}): ${points}\n`;

    // Apply position bonus
    const positionBonus = position * settings.position_multiplier;
    points += positionBonus;
    breakdown += `Position bonus: ${positionBonus}\n`;

    // Apply time bonus
    const arrivalHour = parseInt(arrivalTime.split(':')[0]);
    if (arrivalHour < 9) {
        const earlyBonus = settings.early_bonus;
        points += earlyBonus;
        breakdown += `Early arrival bonus: ${earlyBonus}\n`;
    }

    // Apply scenario multiplier
    let multiplier = 1;
    if (scenario === 'weekend') multiplier = settings.weekend_multiplier;
    if (scenario === 'holiday') multiplier = settings.holiday_multiplier;
    if (multiplier > 1) {
        const bonusPoints = points * (multiplier - 1);
        points *= multiplier;
        breakdown += `${scenario} multiplier (${multiplier}x): +${bonusPoints}\n`;
    }

    // Apply streak bonus
    if (streak > 0) {
        const streakBonus = streak * settings.consecutive_days_bonus;
        points += streakBonus;
        breakdown += `Streak bonus (${streak} days): ${streakBonus}\n`;
    }

    breakdown += `\nTotal Points: ${points.toFixed(2)}`;
    document.getElementById('pointsBreakdown').textContent = breakdown;
}

// Add event listeners to all inputs to update calculation in real-time
document.querySelectorAll('.calculator input, .calculator select').forEach(input => {
    input.addEventListener('change', calculatePoints);
});

// Initial calculation
calculatePoints();

// Initialize drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
    loadExistingRules();
});

function initializeDragAndDrop() {
    const blocks = document.querySelectorAll('.block');
    const rulesContainer = document.getElementById('rulesContainer');

    blocks.forEach(block => {
        block.addEventListener('dragstart', handleDragStart);
        block.addEventListener('dragend', handleDragEnd);
    });

    rulesContainer.addEventListener('dragover', handleDragOver);
    rulesContainer.addEventListener('dragenter', handleDragEnter);
    rulesContainer.addEventListener('dragleave', handleDragLeave);
    rulesContainer.addEventListener('drop', handleDrop);
    
    // Make existing rules draggable within container
    makeRulesDraggable();
}

function makeRulesDraggable() {
    const ruleBlocks = document.querySelectorAll('.rule-block');
    ruleBlocks.forEach(block => {
        block.draggable = true;
        block.addEventListener('dragstart', handleRuleDragStart);
        block.addEventListener('dragend', handleDragEnd);
    });
}

function handleDragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', JSON.stringify({
        type: e.target.dataset.type,
        template: e.target.dataset.template,
        isNew: true
    }));
}

function handleRuleDragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', JSON.stringify({
        type: e.target.dataset.type,
        template: e.target.innerHTML,
        isNew: false,
        index: Array.from(e.target.parentNode.children).indexOf(e.target)
    }));
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    // Fix: Only handle drag-and-drop if target is the rules container
    if (e.target.id === 'rulesContainer') {
        const afterElement = getDragAfterElement(e.target, e.clientY);
        const draggable = document.querySelector('.dragging');
        if (draggable) {
            if (afterElement) {
                e.target.insertBefore(draggable, afterElement);
            } else {
                e.target.appendChild(draggable);
            }
        }
    }
}

function handleDragEnter(e) {
    e.preventDefault();
    e.target.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.target.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('drag-over');
    
    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
    
    if (data.isNew) {
        createRuleBlock(data.type, data.template);
    } else {
        // Reorder existing rule
        const rules = Array.from(document.querySelectorAll('.rule-block'));
        const movedRule = rules[data.index];
        const afterElement = getDragAfterElement(e.target, e.clientY);
        if (afterElement) {
            e.target.insertBefore(movedRule, afterElement);
        } else {
            e.target.appendChild(movedRule);
        }
    }
    
    updateRulePreview();
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.rule-block:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Update existing createRuleBlock function
function createRuleBlock(type, template) {
    const block = document.createElement('div');
    block.className = 'rule-block';
    block.dataset.type = type;
    block.draggable = true;
    
    // Create content container
    const content = document.createElement('div');
    content.className = 'rule-content';
    
    const templateParts = template.split(/[{}]/);
    templateParts.forEach(part => {
        if (part.trim()) {
            if (part.includes('operator')) {
                const select = document.createElement('select');
                select.innerHTML = `
                    <option value="before">before</option>
                    <option value="after">after</option>
                    <option value="at">at</option>
                    <option value=">=">at or after</option>
                    <option value="<=">at or before</option>
                `;
                content.appendChild(select);
            } else if (part.includes('time')) {
                const input = document.createElement('input');
                input.type = 'time';
                input.value = '09:00';
                content.appendChild(input);
            } else if (part.includes('value') || part.includes('points')) {
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.step = '0.1';
                input.placeholder = part;
                content.appendChild(input);
            } else if (part.includes('status')) {
                const select = document.createElement('select');
                select.innerHTML = `
                    <option value="in_office">in office</option>
                    <option value="remote">remote</option>
                    <option value="sick">sick</option>
                    <option value="leave">leave</option>
                `;
                content.appendChild(select);
            } else if (part.includes('day')) {
                const select = document.createElement('select');
                select.innerHTML = `
                    <option value="weekday">weekday</option>
                    <option value="weekend">weekend</option>
                    <option value="monday">Monday</option>
                    <option value="friday">Friday</option>
                `;
                content.appendChild(select);
            } else {
                const span = document.createElement('span');
                span.textContent = part;
                content.appendChild(span);
            }
        }
    });

    // Add content to block
    block.appendChild(content);

    // Add delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = '✕';
    deleteBtn.className = 'delete-rule';
    deleteBtn.onclick = () => {
        block.remove();
        updateRulePreview();
    };
    block.appendChild(deleteBtn);

    // Add event listeners
    block.addEventListener('dragstart', handleRuleDragStart);
    block.addEventListener('dragend', handleDragEnd);

    // Append to container
    const container = document.getElementById('rulesContainer');
    container.appendChild(block);
    updateRulePreview();
}

function updateRulePreview() {
    const rules = [];
    document.querySelectorAll('.rule-block').forEach(block => {
        const parts = [];
        block.childNodes.forEach(node => {
            if (node.tagName === 'SELECT' || node.tagName === 'INPUT') {
                parts.push(node.value);
            } else if (node.tagName === 'SPAN') {
                parts.push(node.textContent.trim());
            }
        });
        rules.push(parts.join(' '));
    });

    const preview = rules.join('\n');
    document.getElementById('rulePreview').textContent = preview;

    // Add example calculation
    const example = calculateExampleWithRules(rules);
    document.getElementById('rulePreview').textContent += '\n\nExample Calculation:\n' + example;
}

function calculateExampleWithRules(rules) {
    const exampleEntry = {
        time: '09:00',
        date: new Date().toISOString().split('T')[0],
        status: 'in_office',
        name: 'Example User'
    };

    let points = 10; // Base points
    let explanation = `Base points: ${points}\n`;

    rules.forEach(rule => {
        // Parse and apply rule logic here
        // This is a simplified version
        if (rule.includes('add')) {
            const amount = parseInt(rule.match(/add (\d+)/)[1]);
            points += amount;
            explanation += `Added ${amount} points\n`;
        } else if (rule.includes('multiply')) {
            const factor = parseFloat(rule.match(/multiply.*?(\d+\.?\d*)/)[1]);
            points *= factor;
            explanation += `Multiplied by ${factor}\n`;
        }
    });

    explanation += `Final points: ${points}`;
    return explanation;
}

// ...existing code...

function saveRules() {
    const rules = collectRulesFromEditor();
    // Store rules in hidden input for form submission
    document.getElementById('rulesInput').value = JSON.stringify(rules);
    
    // Update preview
    document.getElementById('rulePreview').textContent = formatRulesPreview(rules);
    
    // Save settings via form submission
    const formData = new FormData(document.getElementById('settingsForm'));
    const settings = {
        points: {
            in_office: parseInt(formData.get('points.in_office')),
            remote: parseInt(formData.get('points.remote')),
            sick: parseInt(formData.get('points.sick')),
            leave: parseInt(formData.get('points.leave')),
            rules: rules  // Add the rules array here
        },
        late_bonus: parseFloat(formData.get('late_bonus')),
        remote_days: {},
        core_users: Array.from(document.querySelectorAll('.core-user-checkbox:checked'))
                       .map(checkbox => checkbox.value),
        enable_streaks: document.getElementById('enable_streaks').checked,
        streak_multiplier: parseFloat(document.getElementById('streak_multiplier').value)
    };

    // Send to server
    fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Server returned ' + response.status);
        }
        return response.json();
    })
    .then(result => {
        alert('Rules saved successfully!');
        document.getElementById('rulesEditorModal').style.display = 'none';
    })
    .catch(error => {
        console.error('Error saving rules:', error);
        alert('Error saving rules: ' + error.message);
    });
}

// Add helper function to format rules preview
function formatRulesPreview(rules) {
    return rules.map(rule => {
        if (rule.type === 'condition') {
            if (rule.arrival) {
                return `if arrival ${rule.operator} ${rule.time}`;
            } else if (rule.working) {
                return `if working ${rule.status}`;
            } else if (rule.day) {
                return `if day is ${rule.day}`;
            } else if (rule.streak) {
                return `if streak ${rule.operator} ${rule.value}`;
            }
        } else if (rule.type === 'action') {
            if (rule.award) {
                return `award ${rule.points} points`;
            } else if (rule.multiply) {
                return `multiply points by ${rule.value}`;
            } else if (rule.streak) {
                return `add streak bonus`;
            }
        }
        return '';
    }).filter(Boolean).join('\n');
}

// Add this function to store state when modal closes
function saveCurrentState() {
    savedRules = collectRulesFromEditor();
    document.getElementById('rulesInput').value = JSON.stringify(savedRules);
}

// Update loadSavedRules to use proper JSON parsing
function loadSavedRules() {
    const rulesJson = document.getElementById('rulesJson');
    if (rulesJson && rulesJson.value) {
        try {
            savedRules = JSON.parse(rulesJson.value);
            const rulesContainer = document.getElementById('rulesContainer');
            rulesContainer.innerHTML = '';
            savedRules.forEach(rule => createRuleBlockFromData(rule));
            updateRulePreview();
        } catch (e) {
            console.error('Error loading saved rules:', e);
            savedRules = [];
        }
    }
}

// Add this function to collect rules from the editor
function collectRulesFromEditor() {
    const rules = [];
    document.querySelectorAll('.rule-block').forEach(block => {
        const type = block.dataset.type;
        const rule = { type };
        
        // Get all inputs and selects from the block
        const elements = block.querySelectorAll('input, select');
        const spans = block.querySelectorAll('span');
        
        // Build rule based on its type
        if (type === 'condition') {
            // Get first span text (should be 'if')
            const action = spans[0].textContent.trim();
            if (action === 'if') {
                const condition = spans[1].textContent.trim();
                
                if (condition === 'arrival') {
                    rule.arrival = true;
                    rule.operator = elements[0].value;  // First select is operator
                    rule.time = elements[1].value;      // Second input is time
                }
                else if (condition === 'working') {
                    rule.working = true;
                    rule.status = elements[0].value;    // Status select
                }
                else if (condition === 'day') {
                    rule.day = elements[0].value;       // Day select
                }
                else if (condition === 'streak') {
                    rule.streak = true;
                    rule.operator = elements[0].value;  // Operator select
                    rule.value = elements[1].value;     // Value input
                }
            }
        } 
        else if (type === 'action') {
            const action = spans[0].textContent.trim();
            if (action === 'award') {
                rule.award = true;
                rule.points = parseFloat(elements[0].value);
            }
            else if (action === 'multiply') {
                rule.multiply = true;
                rule.value = parseFloat(elements[0].value);
            }
            else if (action === 'add') {
                rule.streak = true;
            }
        }
        
        rules.push(rule);
    });
    
    return rules;
}

// ...rest of existing code...
var settings = {{ settings_data|tojson|safe }} || {};
</script>
{% endblock %}
